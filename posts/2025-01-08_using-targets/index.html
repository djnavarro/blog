<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.52">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Danielle Navarro">
<meta name="dcterms.date" content="2025-01-08">
<meta name="description" content="In which our intrepid adventurer turns a hacky data visualisation exercise into an analysis pipeline; builds an R blog with litedown and targets; and tries to wrap her head around the crews integration for multithreaded target building">

<title>Three short stories about targets – Notes from a data witch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #eeeeee;
      }
</style>
<link href="../../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../../site_libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="../../site_libs/vis-9.1.0/vis-network.min.js"></script>
<script src="../../site_libs/visNetwork-binding-2.1.2/visNetwork.js"></script>


<link rel="stylesheet" href="../../shared/styles.css">
<meta property="og:title" content="Three short stories about targets – Notes from a data witch">
<meta property="og:description" content="In which our intrepid adventurer turns a hacky data visualisation exercise into an analysis pipeline; builds an R blog with litedown and targets; and tries to wrap her head around the crews integration for multithreaded target building">
<meta property="og:image" content="https://blog.djnavarro.net/posts/2025-01-08_using-targets/img/engin-akyurt-lVD6WBdY_5M-unsplash.jpg">
<meta property="og:site_name" content="Notes from a data witch">
<meta property="og:image:alt" content="A dartboard with a dart on the bullseye">
<meta name="twitter:title" content="Three short stories about targets – Notes from a data witch">
<meta name="twitter:description" content="In which our intrepid adventurer turns a hacky data visualisation exercise into an analysis pipeline; builds an R blog with litedown and targets; and tries to wrap her head around the crews integration for multithreaded target building">
<meta name="twitter:image" content="https://blog.djnavarro.net/posts/2025-01-08_using-targets/img/engin-akyurt-lVD6WBdY_5M-unsplash.jpg">
<meta name="twitter:creator" content="@djnavarro">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image:alt" content="A dartboard with a dart on the bullseye">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml"> 
<span class="menu-text">RSS</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-sites" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Sites</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-sites">    
        <li>
    <a class="dropdown-item" href="https://djnavarro.net">
 <span class="dropdown-text">Homepage</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://blog.djnavarro.net">
 <span class="dropdown-text">Data science blog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://art.djnavarro.net">
 <span class="dropdown-text">Generative art</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://papers.djnavarro.net">
 <span class="dropdown-text">Academic papers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://djnavarro.net/sites">
 <span class="dropdown-text">More…</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Three short stories about targets</h1>
                  <div>
        <div class="description">
          In which our intrepid adventurer turns a hacky data visualisation exercise into an analysis pipeline; builds an R blog with litedown and targets; and tries to wrap her head around the crews integration for multithreaded target building
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">Reproducibility</div>
                <div class="quarto-category">Parallel Computing</div>
                <div class="quarto-category">Blogging</div>
                <div class="quarto-category">Literate Programming</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://djnavarro.net">Danielle Navarro</a> <a href="https://orcid.org/0000-0001-7648-6578" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 8, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#story-1-an-analysis-pipeline" id="toc-story-1-an-analysis-pipeline" class="nav-link active" data-scroll-target="#story-1-an-analysis-pipeline">Story 1: An analysis pipeline</a>
  <ul class="collapse">
  <li><a href="#what-does-the-analysis-do" id="toc-what-does-the-analysis-do" class="nav-link" data-scroll-target="#what-does-the-analysis-do">What does the analysis do?</a></li>
  <li><a href="#defining-the-pipeline" id="toc-defining-the-pipeline" class="nav-link" data-scroll-target="#defining-the-pipeline">Defining the pipeline</a></li>
  <li><a href="#running-the-pipeline" id="toc-running-the-pipeline" class="nav-link" data-scroll-target="#running-the-pipeline">Running the pipeline</a></li>
  <li><a href="#when-the-project-changes" id="toc-when-the-project-changes" class="nav-link" data-scroll-target="#when-the-project-changes">When the project changes</a></li>
  <li><a href="#epilogue" id="toc-epilogue" class="nav-link" data-scroll-target="#epilogue">Epilogue</a></li>
  </ul></li>
  <li><a href="#story-2-building-a-blog" id="toc-story-2-building-a-blog" class="nav-link" data-scroll-target="#story-2-building-a-blog">Story 2: Building a blog</a>
  <ul class="collapse">
  <li><a href="#designing-the-blog" id="toc-designing-the-blog" class="nav-link" data-scroll-target="#designing-the-blog">Designing the blog</a></li>
  <li><a href="#the-liteblog-class" id="toc-the-liteblog-class" class="nav-link" data-scroll-target="#the-liteblog-class">The Liteblog class</a></li>
  <li><a href="#the-build-pipeline" id="toc-the-build-pipeline" class="nav-link" data-scroll-target="#the-build-pipeline">The build pipeline</a></li>
  <li><a href="#building-the-blog" id="toc-building-the-blog" class="nav-link" data-scroll-target="#building-the-blog">Building the blog</a></li>
  <li><a href="#always-run-targets" id="toc-always-run-targets" class="nav-link" data-scroll-target="#always-run-targets">Always-run targets</a></li>
  <li><a href="#dynamic-branching" id="toc-dynamic-branching" class="nav-link" data-scroll-target="#dynamic-branching">Dynamic branching</a></li>
  <li><a href="#editing-an-existing-page" id="toc-editing-an-existing-page" class="nav-link" data-scroll-target="#editing-an-existing-page">Editing an existing page</a></li>
  <li><a href="#adding-new-pages" id="toc-adding-new-pages" class="nav-link" data-scroll-target="#adding-new-pages">Adding new pages</a></li>
  <li><a href="#editing-the-style-files" id="toc-editing-the-style-files" class="nav-link" data-scroll-target="#editing-the-style-files">Editing the style files</a></li>
  <li><a href="#epilogue-1" id="toc-epilogue-1" class="nav-link" data-scroll-target="#epilogue-1">Epilogue</a></li>
  </ul></li>
  <li><a href="#story-3-parallel-computing" id="toc-story-3-parallel-computing" class="nav-link" data-scroll-target="#story-3-parallel-computing">Story 3: Parallel computing</a>
  <ul class="collapse">
  <li><a href="#minimal-version" id="toc-minimal-version" class="nav-link" data-scroll-target="#minimal-version">Minimal version</a></li>
  <li><a href="#slightly-less-minimal-version" id="toc-slightly-less-minimal-version" class="nav-link" data-scroll-target="#slightly-less-minimal-version">Slightly less minimal version</a></li>
  <li><a href="#epilogue-2" id="toc-epilogue-2" class="nav-link" data-scroll-target="#epilogue-2">Epilogue</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<!--------------- my typical setup ----------------->
<!--------------- post begins here ----------------->
<p>About 18 months ago I wrote a post about <a href="../../posts/2023-06-30_makefiles/">balrogs and makefiles</a>. The post was long, strange, but also cathartic. It had bothered me for years that I didn’t really understand <a href="https://www.gnu.org/software/make/">make</a> as well as I wanted to, and it was really helpful to write up some notes about it as a way of teaching myself how to use it more effectively than I had done in the past.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Buried at the very end of the post is an almost-apologetic reference to the <a href="https://docs.ropensci.org/targets/">targets</a> R package by Will Landau, which provides a similar toolkit designed to work cleanly for R users.</p>
<p>Even then I knew that I was going to need to learn how to use targets, but somehow I never quite got around to it… life gets in the way, I suppose. I have been preoccupied by other tasks, sadly, and it has taken me until now to (a) sit down and read through the <a href="https://books.ropensci.org/targets/">targets user manual</a>, and (b) come up with some fun side projects that would give me the opportunity to try it out.</p>
<p>Thankfully, I recently managed to set some time aside to teach myself how to use the package, using three toy projects that I bundled together into a <a href="https://github.com/djnavarro/tartoys">small github repository</a>. Realising that I would inevitably forget what I’ve learned if I didn’t write up some notes on the projects, I decided to write them up as a blog post.</p>
<p>So, here goes. This is a tale of three targets…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(legendry)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyselect)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br><br></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./img/chuttersnap-_EFvjSgbw1c-unsplash.jpg" class="img-fluid figure-img"></p>
<figcaption>Pipelines, of course</figcaption>
</figure>
</div>
<p><br></p>
<section id="story-1-an-analysis-pipeline" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="story-1-an-analysis-pipeline">Story 1: An analysis pipeline</h2>
<p>The first pipeline I built using targets was based the fun <a href="https://github.com/rfordatascience/tidytuesday/tree/main/data/2024/2024-12-17">Tidy Tuesday</a> visualisations that I described in my <a href="../../posts/2025-01-01_schools-of-magic/">last post</a>. In that post, I talked about two images I made using a data set about Dungeons &amp; Dragons spells. When I wrote that post, I didn’t talk about targets at all, and none of the code presented in that blog post is written in a “targets-friendly” way. However, although that form of the code was the simplest way to write it up, it’s not how I originally wrote it. It was originally written as a targets pipeline.</p>
<p>As it happens, I have a slightly-modified copy of the project in the <code>spells</code> directory within this blog post, so that I can play with the project within this post. Yay! But this in turn brings us to the first point to make about targets: it’s a <em>project-oriented</em> tool, in the sense that each project corresponds to a single folder (and its sub-folders), and not surprisingly it’s easiest to use from within the project. To make my life easier I’ll sometimes change that directory so that when I’m discussing a specific targets project, the code will execute from the root directory of that project. At the R console we would use <code>setwd()</code> to do so, but that’s not the best approach within a knitr-based tool (quarto, rmarkdown, etc), and you will get warning messages if you try to do it that way. The preferred method for changing directories with an R markdown or quarto document is to set the <code>root.dir</code> knitr option. Because I’ll be doing that several times in this post, I’ll write a little convenience function to take care of this whenever I need to switch to a new project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>set_knitr_dir <span class="ot">&lt;-</span> <span class="cf">function</span>(dir, <span class="at">post =</span> <span class="st">"2025-01-08_using-targets"</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_knit<span class="sc">$</span><span class="fu">set</span>(<span class="at">root.dir =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"posts"</span>, post, dir))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set_knitr_dir</span>(<span class="st">"spells"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, let’s take a look at the structure of this project. At the moment this is a clean project (i.e., no code has been run yet), so it contains only the source files. There are only three:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_tree</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
├── _targets.R
├── analysis.R
└── spells.csv</code></pre>
</div>
</div>
<p>Here’s what each file does:</p>
<ul>
<li>The <code>spells.csv</code> file is the data set I wish to analyse</li>
<li>The <code>analysis.R</code> script defines a collection of functions which, when called, will perform the required analyses and generate the outputs</li>
<li>The <code>_targets.R</code> script is (unsurprisingly) the build script</li>
</ul>
<p>In a moment I’ll talk about the <code>_targets.R</code> script, but first I’ll quickly describe what the analysis itself does.</p>
<section id="what-does-the-analysis-do" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="what-does-the-analysis-do">What does the analysis do?</h3>
<p>If you read the <a href="../../posts/2025-01-01_schools-of-magic/">schools of magic</a> post that I wrote earlier this year, you’ve already seen the code underpinning the analysis. The only difference between the version in the previous post and the version I’ve used here is that the <code>analysis.R</code> script wraps each step of the analysis into a function. This is pretty crucial to constructing a targets pipeline, actually, and the targets user manual has a whole section discussing <a href="https://books.ropensci.org/targets/functions.html">function-oriented workflow</a>.</p>
<blockquote class="blockquote">
<p>Functions are the building blocks of most computer code. They make code easier to think about, and they break down complicated ideas into small manageable pieces. Out of context, you can develop and test a function in isolation without mentally juggling the rest of the project. In the context of the whole workflow, functions are convenient shorthand to make your work easier to read.</p>
</blockquote>
<p>One thing that continually surprises me about analysis scripts that I encounter in the wild is that <em>analysts don’t write functions enough</em>. It’s easily the most common trap I see people falling into, to be honest, and it leads to some very dangerous and hard-to-isolate bugs because the dependencies between different parts of the code become hard to see as the script gets longer. So I am a big fan of the design feature in targets that pushes the user to break a big analysis into a smaller number of functions that perform specific tasks. For example, once the <code>spells</code> data set has been loaded, the pipeline that constructs the “spell dice” plot is encapsulated by two key functions:</p>
<ul>
<li><code>dice_data()</code> takes the spells data as input, and performs all the data wrangling steps required to construct a tidied version of the data that is suitable for visualisation</li>
<li><code>dice_plot()</code> takes the tidied dice data as input, specifies the “spell dice” plot, and writes it to an output file</li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./spells-cache/dice_pic.png" class="img-fluid figure-img"></p>
<figcaption>dice_pic.png</figcaption>
</figure>
</div>
</div></div><p>The “schools of magic” plot is slightly more elaborate, and uses three functions:</p>
<ul>
<li><code>scholastic_data()</code> takes the spells data as input, and performs the data wrangling steps required to create tidy data suitable for constructing the heatmap</li>
<li><code>scholastic_clusters()</code> takes this tidy data as input, and the performs additional steps required to construct the hierarchical clustering used to draw dendrograms alongside the heatmap</li>
<li><code>scholastic_plot()</code> takes the data set and the clustering as input, and uses them to build the “schools of magic” plot that is written to an output file</li>
</ul>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./spells-cache/scholastic_pic.png" class="img-fluid figure-img"></p>
<figcaption>scholastic_pic.png</figcaption>
</figure>
</div>
</div></div><p>The actual code for these functions isn’t very important for the purposes of understanding the targets pipelinem, and in any case I’ve described the plots in detail before. But for what it’s worth, the exact code is included below the fold here:</p>
<div class="cell">
<div class="code-with-filename">
<details class="code-fold">
<summary>Click to show/hide the analysis.R code</summary>
<div class="code-with-filename-file">
<pre><strong>analysis.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># spell dice plot ---------------------------------------------------------</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>dice_data <span class="ot">&lt;-</span> <span class="cf">function</span>(spells) {</span>
<span id="cb5-4"><a href="#cb5-4"></a>  dice_dat <span class="ot">&lt;-</span> spells <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="fu">select</span>(name, level, description) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-7"><a href="#cb5-7"></a>      <span class="at">dice_txt =</span> <span class="fu">str_extract_all</span>(description, <span class="st">"</span><span class="sc">\\</span><span class="st">b</span><span class="sc">\\</span><span class="st">d+d</span><span class="sc">\\</span><span class="st">d+</span><span class="sc">\\</span><span class="st">b"</span>),</span>
<span id="cb5-8"><a href="#cb5-8"></a>      <span class="at">dice_txt =</span> purrr<span class="sc">::</span><span class="fu">map</span>(dice_txt, unique)</span>
<span id="cb5-9"><a href="#cb5-9"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="fu">unnest_longer</span>(</span>
<span id="cb5-11"><a href="#cb5-11"></a>      <span class="at">col =</span> <span class="st">"dice_txt"</span>,</span>
<span id="cb5-12"><a href="#cb5-12"></a>      <span class="at">values_to =</span> <span class="st">"dice_txt"</span>,</span>
<span id="cb5-13"><a href="#cb5-13"></a>      <span class="at">indices_to =</span> <span class="st">"position"</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-16"><a href="#cb5-16"></a>      <span class="at">dice_num =</span> dice_txt <span class="sc">|&gt;</span> <span class="fu">str_extract</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">d+(?=d)"</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb5-17"><a href="#cb5-17"></a>      <span class="at">dice_die =</span> dice_txt <span class="sc">|&gt;</span> <span class="fu">str_extract</span>(<span class="st">"(?&lt;=d)</span><span class="sc">\\</span><span class="st">d+"</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb5-18"><a href="#cb5-18"></a>      <span class="at">dice_val =</span> dice_num <span class="sc">*</span> (dice_die <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb5-19"><a href="#cb5-19"></a>      <span class="at">dice_txt =</span> <span class="fu">factor</span>(dice_txt) <span class="sc">|&gt;</span> <span class="fu">fct_reorder</span>(dice_val)</span>
<span id="cb5-20"><a href="#cb5-20"></a>    )</span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="fu">return</span>(dice_dat)</span>
<span id="cb5-22"><a href="#cb5-22"></a>}</span>
<span id="cb5-23"><a href="#cb5-23"></a></span>
<span id="cb5-24"><a href="#cb5-24"></a>dice_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(dice_dat) {</span>
<span id="cb5-25"><a href="#cb5-25"></a>  </span>
<span id="cb5-26"><a href="#cb5-26"></a>  palette <span class="ot">&lt;-</span> <span class="fu">hcl.colors</span>(<span class="at">n =</span> <span class="dv">10</span>, <span class="at">palette =</span> <span class="st">"PuOr"</span>)</span>
<span id="cb5-27"><a href="#cb5-27"></a>  </span>
<span id="cb5-28"><a href="#cb5-28"></a>  labs <span class="ot">&lt;-</span> dice_dat <span class="sc">|&gt;</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>    <span class="fu">summarise</span>(</span>
<span id="cb5-30"><a href="#cb5-30"></a>      <span class="at">dice_txt =</span> <span class="fu">first</span>(dice_txt),</span>
<span id="cb5-31"><a href="#cb5-31"></a>      <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb5-32"><a href="#cb5-32"></a>      <span class="at">.by =</span> dice_txt</span>
<span id="cb5-33"><a href="#cb5-33"></a>    )</span>
<span id="cb5-34"><a href="#cb5-34"></a>  </span>
<span id="cb5-35"><a href="#cb5-35"></a>  pic <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb5-36"><a href="#cb5-36"></a>    <span class="at">data =</span> dice_dat,</span>
<span id="cb5-37"><a href="#cb5-37"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb5-38"><a href="#cb5-38"></a>      <span class="at">x =</span> dice_txt,</span>
<span id="cb5-39"><a href="#cb5-39"></a>      <span class="at">fill =</span> <span class="fu">factor</span>(level)</span>
<span id="cb5-40"><a href="#cb5-40"></a>    )</span>
<span id="cb5-41"><a href="#cb5-41"></a>  ) <span class="sc">+</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>    <span class="fu">geom_bar</span>(<span class="at">color =</span> <span class="st">"#222"</span>) <span class="sc">+</span></span>
<span id="cb5-43"><a href="#cb5-43"></a>    <span class="fu">geom_label_repel</span>(</span>
<span id="cb5-44"><a href="#cb5-44"></a>      <span class="at">data =</span> labs,</span>
<span id="cb5-45"><a href="#cb5-45"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb5-46"><a href="#cb5-46"></a>        <span class="at">x =</span> dice_txt,</span>
<span id="cb5-47"><a href="#cb5-47"></a>        <span class="at">y =</span> count,</span>
<span id="cb5-48"><a href="#cb5-48"></a>        <span class="at">label =</span> dice_txt</span>
<span id="cb5-49"><a href="#cb5-49"></a>      ),</span>
<span id="cb5-50"><a href="#cb5-50"></a>      <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb5-51"><a href="#cb5-51"></a>      <span class="at">direction =</span> <span class="st">"y"</span>,</span>
<span id="cb5-52"><a href="#cb5-52"></a>      <span class="at">seed =</span> <span class="dv">1</span>,</span>
<span id="cb5-53"><a href="#cb5-53"></a>      <span class="at">nudge_y =</span> <span class="dv">4</span>,</span>
<span id="cb5-54"><a href="#cb5-54"></a>      <span class="at">color =</span> <span class="st">"#ccc"</span>,</span>
<span id="cb5-55"><a href="#cb5-55"></a>      <span class="at">fill =</span> <span class="st">"#222"</span>,</span>
<span id="cb5-56"><a href="#cb5-56"></a>      <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-57"><a href="#cb5-57"></a>      <span class="at">inherit.aes =</span> <span class="cn">FALSE</span></span>
<span id="cb5-58"><a href="#cb5-58"></a>    ) <span class="sc">+</span></span>
<span id="cb5-59"><a href="#cb5-59"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb5-60"><a href="#cb5-60"></a>      <span class="at">name =</span> <span class="st">"Spell level"</span>,</span>
<span id="cb5-61"><a href="#cb5-61"></a>      <span class="at">values =</span> palette</span>
<span id="cb5-62"><a href="#cb5-62"></a>    ) <span class="sc">+</span></span>
<span id="cb5-63"><a href="#cb5-63"></a>    <span class="fu">scale_x_discrete</span>(</span>
<span id="cb5-64"><a href="#cb5-64"></a>      <span class="at">name =</span> <span class="st">"Increasing average outcome \u27a1"</span>,</span>
<span id="cb5-65"><a href="#cb5-65"></a>      <span class="at">breaks =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-66"><a href="#cb5-66"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(.<span class="dv">05</span>)</span>
<span id="cb5-67"><a href="#cb5-67"></a>    ) <span class="sc">+</span></span>
<span id="cb5-68"><a href="#cb5-68"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">name =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb5-69"><a href="#cb5-69"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Dice rolls described in D&amp;D spell descriptions"</span>) <span class="sc">+</span></span>
<span id="cb5-70"><a href="#cb5-70"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb5-71"><a href="#cb5-71"></a>    <span class="fu">theme</span>(</span>
<span id="cb5-72"><a href="#cb5-72"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#222"</span>),</span>
<span id="cb5-73"><a href="#cb5-73"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-74"><a href="#cb5-74"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-75"><a href="#cb5-75"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-76"><a href="#cb5-76"></a>      <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">units =</span> <span class="st">"cm"</span>),</span>
<span id="cb5-77"><a href="#cb5-77"></a>      <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb5-78"><a href="#cb5-78"></a>      <span class="at">legend.position.inside =</span> <span class="fu">c</span>(.<span class="dv">3</span>, .<span class="dv">825</span>),</span>
<span id="cb5-79"><a href="#cb5-79"></a>      <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb5-80"><a href="#cb5-80"></a>      <span class="at">legend.title.position =</span> <span class="st">"top"</span>,</span>
<span id="cb5-81"><a href="#cb5-81"></a>      <span class="at">legend.byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb5-82"><a href="#cb5-82"></a>    )</span>
<span id="cb5-83"><a href="#cb5-83"></a>  </span>
<span id="cb5-84"><a href="#cb5-84"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb5-85"><a href="#cb5-85"></a>    <span class="at">filename =</span> <span class="st">"dice_pic.png"</span>,</span>
<span id="cb5-86"><a href="#cb5-86"></a>    <span class="at">plot =</span> pic,</span>
<span id="cb5-87"><a href="#cb5-87"></a>    <span class="at">width =</span> <span class="dv">2000</span>,</span>
<span id="cb5-88"><a href="#cb5-88"></a>    <span class="at">height =</span> <span class="dv">1000</span>,</span>
<span id="cb5-89"><a href="#cb5-89"></a>    <span class="at">units =</span> <span class="st">"px"</span>,</span>
<span id="cb5-90"><a href="#cb5-90"></a>    <span class="at">dpi =</span> <span class="dv">150</span></span>
<span id="cb5-91"><a href="#cb5-91"></a>  )</span>
<span id="cb5-92"><a href="#cb5-92"></a>  </span>
<span id="cb5-93"><a href="#cb5-93"></a>  <span class="fu">return</span>(<span class="st">"dice_pic.png"</span>)</span>
<span id="cb5-94"><a href="#cb5-94"></a>}</span>
<span id="cb5-95"><a href="#cb5-95"></a></span>
<span id="cb5-96"><a href="#cb5-96"></a></span>
<span id="cb5-97"><a href="#cb5-97"></a><span class="co"># schools of magic plot ---------------------------------------------------</span></span>
<span id="cb5-98"><a href="#cb5-98"></a></span>
<span id="cb5-99"><a href="#cb5-99"></a><span class="co"># constructs the data frame used by geom_tile() later</span></span>
<span id="cb5-100"><a href="#cb5-100"></a>scholastic_data <span class="ot">&lt;-</span> <span class="cf">function</span>(spells) {</span>
<span id="cb5-101"><a href="#cb5-101"></a>  spells <span class="sc">|&gt;</span></span>
<span id="cb5-102"><a href="#cb5-102"></a>    <span class="fu">select</span>(name, school, bard<span class="sc">:</span>wizard) <span class="sc">|&gt;</span></span>
<span id="cb5-103"><a href="#cb5-103"></a>    <span class="fu">pivot_longer</span>(</span>
<span id="cb5-104"><a href="#cb5-104"></a>      <span class="at">cols =</span> bard<span class="sc">:</span>wizard,</span>
<span id="cb5-105"><a href="#cb5-105"></a>      <span class="at">names_to =</span> <span class="st">"class"</span>,</span>
<span id="cb5-106"><a href="#cb5-106"></a>      <span class="at">values_to =</span> <span class="st">"castable"</span></span>
<span id="cb5-107"><a href="#cb5-107"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-108"><a href="#cb5-108"></a>    <span class="fu">summarise</span>(</span>
<span id="cb5-109"><a href="#cb5-109"></a>      <span class="at">count =</span> <span class="fu">sum</span>(castable),</span>
<span id="cb5-110"><a href="#cb5-110"></a>      <span class="at">.by =</span> <span class="fu">c</span>(<span class="st">"school"</span>, <span class="st">"class"</span>)</span>
<span id="cb5-111"><a href="#cb5-111"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-112"><a href="#cb5-112"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-113"><a href="#cb5-113"></a>      <span class="at">school =</span> <span class="fu">str_to_title</span>(school),</span>
<span id="cb5-114"><a href="#cb5-114"></a>      <span class="at">class  =</span> <span class="fu">str_to_title</span>(class)</span>
<span id="cb5-115"><a href="#cb5-115"></a>    )</span>
<span id="cb5-116"><a href="#cb5-116"></a>}</span>
<span id="cb5-117"><a href="#cb5-117"></a></span>
<span id="cb5-118"><a href="#cb5-118"></a><span class="co"># hierarchical clustering for the schools and classes</span></span>
<span id="cb5-119"><a href="#cb5-119"></a>scholastic_clusters <span class="ot">&lt;-</span> <span class="cf">function</span>(dat) {</span>
<span id="cb5-120"><a href="#cb5-120"></a>  </span>
<span id="cb5-121"><a href="#cb5-121"></a>  <span class="co"># matrix of counts for each school/class combination</span></span>
<span id="cb5-122"><a href="#cb5-122"></a>  mat <span class="ot">&lt;-</span> dat <span class="sc">|&gt;</span></span>
<span id="cb5-123"><a href="#cb5-123"></a>    <span class="fu">pivot_wider</span>(</span>
<span id="cb5-124"><a href="#cb5-124"></a>      <span class="at">names_from =</span> <span class="st">"school"</span>,</span>
<span id="cb5-125"><a href="#cb5-125"></a>      <span class="at">values_from =</span> <span class="st">"count"</span></span>
<span id="cb5-126"><a href="#cb5-126"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb5-127"><a href="#cb5-127"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb5-128"><a href="#cb5-128"></a>  <span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> mat<span class="sc">$</span>class</span>
<span id="cb5-129"><a href="#cb5-129"></a>  mat<span class="sc">$</span>class <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-130"><a href="#cb5-130"></a>  <span class="fu">as.matrix</span>(mat)</span>
<span id="cb5-131"><a href="#cb5-131"></a>  </span>
<span id="cb5-132"><a href="#cb5-132"></a>  <span class="co"># each school is a distribution over classes,</span></span>
<span id="cb5-133"><a href="#cb5-133"></a>  <span class="co"># each class is a distribution over schools</span></span>
<span id="cb5-134"><a href="#cb5-134"></a>  class_distribution  <span class="ot">&lt;-</span> mat <span class="sc">/</span> <span class="fu">replicate</span>(<span class="fu">ncol</span>(mat), <span class="fu">rowSums</span>(mat))</span>
<span id="cb5-135"><a href="#cb5-135"></a>  school_distribution <span class="ot">&lt;-</span> <span class="fu">t</span>(mat) <span class="sc">/</span> (<span class="fu">replicate</span>(<span class="fu">nrow</span>(mat), <span class="fu">colSums</span>(mat)))</span>
<span id="cb5-136"><a href="#cb5-136"></a>  </span>
<span id="cb5-137"><a href="#cb5-137"></a>  <span class="co"># pairwise distances</span></span>
<span id="cb5-138"><a href="#cb5-138"></a>  class_dissimilarity  <span class="ot">&lt;-</span> <span class="fu">dist</span>(class_distribution)</span>
<span id="cb5-139"><a href="#cb5-139"></a>  school_dissimilarity <span class="ot">&lt;-</span> <span class="fu">dist</span>(school_distribution)</span>
<span id="cb5-140"><a href="#cb5-140"></a>  </span>
<span id="cb5-141"><a href="#cb5-141"></a>  <span class="co"># hierarchical clustering</span></span>
<span id="cb5-142"><a href="#cb5-142"></a>  clusters <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-143"><a href="#cb5-143"></a>    <span class="at">class =</span> <span class="fu">hclust</span>(class_dissimilarity, <span class="at">method =</span> <span class="st">"average"</span>),</span>
<span id="cb5-144"><a href="#cb5-144"></a>    <span class="at">school =</span> <span class="fu">hclust</span>(school_dissimilarity, <span class="at">method =</span> <span class="st">"average"</span>)</span>
<span id="cb5-145"><a href="#cb5-145"></a>  )</span>
<span id="cb5-146"><a href="#cb5-146"></a>  </span>
<span id="cb5-147"><a href="#cb5-147"></a>  <span class="fu">return</span>(clusters)</span>
<span id="cb5-148"><a href="#cb5-148"></a>}</span>
<span id="cb5-149"><a href="#cb5-149"></a></span>
<span id="cb5-150"><a href="#cb5-150"></a>scholastic_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, clusters) {</span>
<span id="cb5-151"><a href="#cb5-151"></a>  </span>
<span id="cb5-152"><a href="#cb5-152"></a>  pic <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(school, class, <span class="at">fill =</span> count)) <span class="sc">+</span></span>
<span id="cb5-153"><a href="#cb5-153"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb5-154"><a href="#cb5-154"></a>    <span class="fu">scale_x_dendro</span>(</span>
<span id="cb5-155"><a href="#cb5-155"></a>      <span class="at">clust =</span> clusters<span class="sc">$</span>school,</span>
<span id="cb5-156"><a href="#cb5-156"></a>      <span class="at">guide =</span> <span class="fu">guide_axis_dendro</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>),</span>
<span id="cb5-157"><a href="#cb5-157"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb5-158"><a href="#cb5-158"></a>      <span class="at">position =</span> <span class="st">"top"</span></span>
<span id="cb5-159"><a href="#cb5-159"></a>    ) <span class="sc">+</span></span>
<span id="cb5-160"><a href="#cb5-160"></a>    <span class="fu">scale_y_dendro</span>(</span>
<span id="cb5-161"><a href="#cb5-161"></a>      <span class="at">clust =</span> clusters<span class="sc">$</span>class,</span>
<span id="cb5-162"><a href="#cb5-162"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-163"><a href="#cb5-163"></a>    ) <span class="sc">+</span></span>
<span id="cb5-164"><a href="#cb5-164"></a>    <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"RdPu"</span>) <span class="sc">+</span></span>
<span id="cb5-165"><a href="#cb5-165"></a>    <span class="fu">labs</span>(</span>
<span id="cb5-166"><a href="#cb5-166"></a>      <span class="at">x =</span> <span class="st">"The Schools of Magic"</span>,</span>
<span id="cb5-167"><a href="#cb5-167"></a>      <span class="at">y =</span> <span class="st">"The Classes of Character"</span>,</span>
<span id="cb5-168"><a href="#cb5-168"></a>      <span class="at">fill =</span> <span class="st">"Number of Learnable Spells"</span></span>
<span id="cb5-169"><a href="#cb5-169"></a>    ) <span class="sc">+</span></span>
<span id="cb5-170"><a href="#cb5-170"></a>    <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb5-171"><a href="#cb5-171"></a>    <span class="fu">theme</span>(</span>
<span id="cb5-172"><a href="#cb5-172"></a>      <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#222"</span>, <span class="at">color =</span> <span class="st">"#222"</span>),</span>
<span id="cb5-173"><a href="#cb5-173"></a>      <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>), <span class="at">units =</span> <span class="st">"cm"</span>),</span>
<span id="cb5-174"><a href="#cb5-174"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-175"><a href="#cb5-175"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-176"><a href="#cb5-176"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-177"><a href="#cb5-177"></a>      <span class="at">axis.ticks =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"#ccc"</span>),</span>
<span id="cb5-178"><a href="#cb5-178"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb5-179"><a href="#cb5-179"></a>      <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"#222"</span>, <span class="at">color =</span> <span class="st">"#222"</span>)</span>
<span id="cb5-180"><a href="#cb5-180"></a>    )</span>
<span id="cb5-181"><a href="#cb5-181"></a>  </span>
<span id="cb5-182"><a href="#cb5-182"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb5-183"><a href="#cb5-183"></a>    <span class="at">filename =</span> <span class="st">"scholastic_pic.png"</span>,</span>
<span id="cb5-184"><a href="#cb5-184"></a>    <span class="at">plot =</span> pic,</span>
<span id="cb5-185"><a href="#cb5-185"></a>    <span class="at">width =</span> <span class="dv">1000</span>,</span>
<span id="cb5-186"><a href="#cb5-186"></a>    <span class="at">height =</span> <span class="dv">1000</span>,</span>
<span id="cb5-187"><a href="#cb5-187"></a>    <span class="at">units =</span> <span class="st">"px"</span>,</span>
<span id="cb5-188"><a href="#cb5-188"></a>    <span class="at">dpi =</span> <span class="dv">150</span></span>
<span id="cb5-189"><a href="#cb5-189"></a>  )</span>
<span id="cb5-190"><a href="#cb5-190"></a>  </span>
<span id="cb5-191"><a href="#cb5-191"></a>  <span class="fu">return</span>(<span class="st">"scholastic_pic.png"</span>)</span>
<span id="cb5-192"><a href="#cb5-192"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</section>
<section id="defining-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="defining-the-pipeline">Defining the pipeline</h3>
<p>Now that you’ve read the verbal description of what each function does, it’s intuitively pretty clear how the analysis pipeline is supposed to work. Roughly speaking, you’d expect the analysis to be executed using a script like this:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>run_analysis.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># load packages</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">library</span>(tibble)</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="fu">library</span>(readr)</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="fu">library</span>(stringr)</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="fu">library</span>(forcats)</span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="fu">library</span>(legendry)</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co"># read analysis script</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="fu">source</span>(<span class="st">"analysis.R"</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># setup</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>input  <span class="ot">&lt;-</span> <span class="st">"spells.csv"</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>spells <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(input, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co"># make the spell dice plot &amp; write to output</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>dice_dat <span class="ot">&lt;-</span> <span class="fu">dice_data</span>(spells)</span>
<span id="cb6-21"><a href="#cb6-21"></a>dice_pic <span class="ot">&lt;-</span> <span class="fu">dice_plot</span>(dice_dat)</span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co"># make the schools of magic plot &amp; write to output</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>scholastic_dat  <span class="ot">&lt;-</span> <span class="fu">scholastic_data</span>(spells)</span>
<span id="cb6-25"><a href="#cb6-25"></a>scholastic_clus <span class="ot">&lt;-</span> <span class="fu">scholastic_clusters</span>(scholastic_dat)</span>
<span id="cb6-26"><a href="#cb6-26"></a>scholastic_pic  <span class="ot">&lt;-</span> <span class="fu">scholastic_plot</span>(scholastic_dat, scholastic_clus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>So, how does it work with targets? Well, if we take a look at the <code>_targets.R</code> script, we can see it looks suspiciously similar to the code above:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_targets.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># specify required packages</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">tar_option_set</span>(<span class="at">packages =</span> <span class="fu">c</span>(</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="st">"tibble"</span>, <span class="st">"readr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"dplyr"</span>, <span class="st">"stringr"</span>, </span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="st">"tidyr"</span>, <span class="st">"forcats"</span>, <span class="st">"ggrepel"</span>, <span class="st">"legendry"</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>))</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co"># read analysis script</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="fu">tar_source</span>(<span class="st">"analysis.R"</span>)</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="fu">list</span>(</span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="co"># setup</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="fu">tar_target</span>(input, <span class="st">"spells.csv"</span>, <span class="at">format =</span> <span class="st">"file"</span>),</span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">tar_target</span>(spells, <span class="fu">read_csv</span>(input, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)),</span>
<span id="cb7-16"><a href="#cb7-16"></a>  </span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="co"># dice plot</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  <span class="fu">tar_target</span>(dice_dat, <span class="fu">dice_data</span>(spells)),</span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="fu">tar_target</span>(dice_pic, <span class="fu">dice_plot</span>(dice_dat)),</span>
<span id="cb7-20"><a href="#cb7-20"></a>  </span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="co"># scholastic plot</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="fu">tar_target</span>(scholastic_dat, <span class="fu">scholastic_data</span>(spells)),</span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="fu">tar_target</span>(scholastic_clus, <span class="fu">scholastic_clusters</span>(scholastic_dat)),</span>
<span id="cb7-24"><a href="#cb7-24"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb7-25"><a href="#cb7-25"></a>    scholastic_pic,</span>
<span id="cb7-26"><a href="#cb7-26"></a>    <span class="fu">scholastic_plot</span>(scholastic_dat, scholastic_clus)</span>
<span id="cb7-27"><a href="#cb7-27"></a>  )</span>
<span id="cb7-28"><a href="#cb7-28"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>In this pipeline, the set up involves two steps:</p>
<ul>
<li>I’ve used <a href="https://docs.ropensci.org/targets/reference/tar_option_set.html"><code>tar_option_set()</code></a> to declare the required R packages, thereby making those packages available to the pipeline</li>
<li>I’ve used <a href="https://docs.ropensci.org/targets/reference/tar_source.html"><code>tar_source()</code></a> to read the analysis script, thereby making the functions in that file accessible to the pipeline</li>
</ul>
<p>Having taken care of the preliminaries, the pipeline is specified via a list of targets, each of which is defined by a call to <a href="https://docs.ropensci.org/targets/reference/tar_target.html"><code>tar_target()</code></a>. Each target has a <code>name</code>, and is associated with a <code>command</code> that is to be executed. If I’d named the arguments on line 18 in my <code>_targets.R</code> script, the code would look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> dice_dat, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command =</span> <span class="fu">dice_data</span>(spells)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice the similarity to line 20 of the <code>run_analysis.R</code> script:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dice_dat <span class="ot">&lt;-</span> <span class="fu">dice_data</span>(spells)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In essence, that’s what I’m doing with the call to <code>tar_target()</code>. I’m specifying that the command <code>dice_data(spells)</code> is to be executed, and the results should be stored as the variable <code>dice_dat</code>. However, instead of immediately executing this code in the current R environment, what <code>tar_target()</code> does is create the infrastructure so that this command can be incorporated into the pipeline when it actually gets built. With one exception, this is the recipe I followed for constructing all the targets in my <code>_targets.R</code> script.</p>
<p>The one exception to this pattern occurs on line 14 of <code>_targets.R</code>, where my target is defined by this call to <code>tar_target()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> input, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command =</span> <span class="st">"spells.csv"</span>, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In one sense, this target is pretty much the same as the others: it defines a variable called <code>input</code> using the “command” <code>"spells.csv"</code>, and so in that respect it’s much the same as line 16 of the <code>run_analysis.R</code> script. However, notice that I’ve also specified that <code>format = "file"</code>. This tells targets that <code>"spells.csv"</code> isn’t <em>just</em> a string, it’s also the name of a file that needs to be tracked. By declaring it as a file target, I’m ensuring that if the <code>spells.csv</code> file gets altered in some way, this target and any target that depends on it will need to be rebuilt.</p>
<p>The <a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html"><code>tar_visnetwork()</code></a> function provides a handy way of visualising the structure of a pipeline as a little HTML widget. To keep things as simple as possible, at least for the moment, I’ll set <code>targets_only = TRUE</code> so that the graph ignores the functions defined in <code>analysis.R</code>, and only focuses on the targets themselves:<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>(<span class="at">targets_only =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-06484ed42468d86de4a4" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-06484ed42468d86de4a4">{"x":{"nodes":{"name":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"type":["stem","stem","stem","stem","stem","stem","stem"],"description":[null,null,null,null,null,null,null],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null,null,null,null],"bytes":[null,null,null,null,null,null,null],"branches":[null,null,null,null,null,null,null],"label":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"level":[3,4,1,4,3,5,2],"shape":["dot","dot","dot","dot","dot","dot","dot"]},"edges":{"from":["scholastic_dat","spells","input","scholastic_clus","scholastic_dat","dice_dat","spells"],"to":["scholastic_clus","scholastic_dat","spells","scholastic_pic","scholastic_pic","dice_pic","dice_dat"],"arrows":["to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem"],"color":["#78B7C5","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>All these targets are shown in blue, indicating that they are “outdated”. That’s to be expected at this point, of course: I haven’t actually run anything yet! I’ll get to that momentarily, but before I do I’ll call <a href="https://docs.ropensci.org/targets/reference/tar_outdated.html"><code>tar_outdated()</code></a> to confirm the obvious:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_outdated</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "scholastic_clus" "scholastic_dat"  "spells"          "scholastic_pic" 
[5] "dice_pic"        "input"           "dice_dat"       </code></pre>
</div>
</div>
<p>These are the targets that need to be (re)run.</p>
</section>
<section id="running-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="running-the-pipeline">Running the pipeline</h3>
<p>Okay, it is now time to run the pipeline. We can do this by calling <a href="https://docs.ropensci.org/targets/reference/tar_make.html"><code>tar_make()</code></a>. Here’s what happens when we do that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>▶ dispatched target input
● completed target input [0.314 seconds, 302.514 kilobytes]
▶ dispatched target spells
● completed target spells [0.111 seconds, 73.966 kilobytes]
▶ dispatched target scholastic_dat
● completed target scholastic_dat [0.016 seconds, 401 bytes]
▶ dispatched target dice_dat
● completed target dice_dat [0.024 seconds, 33.486 kilobytes]
▶ dispatched target scholastic_clus
● completed target scholastic_clus [0.014 seconds, 634 bytes]
▶ dispatched target dice_pic
● completed target dice_pic [0.908 seconds, 65 bytes]
▶ dispatched target scholastic_pic
● completed target scholastic_pic [0.229 seconds, 71 bytes]
▶ ended pipeline [1.708 seconds]</code></pre>
</div>
</div>
<p>The output here is pretty descriptive, but it’s still worth expanding on it a little. For each target, there are two lines of output that look like this:</p>
<pre><code>▶ dispatched target TARGETNAME
● completed target TARGETNAME [blah seconds, blah kilobytes]</code></pre>
<p>What these two lines mean is that, under the hood, targets “dispatches” the task to a separate R session using the <a href="https://github.com/r-lib/callr/">callr</a> package, and the code is executed there. The target is deemed “completed” once that R session finishes running the code and returns the output. This approach has two advantages over simply running the code at the console. First, it is more reproducible, because each target is run in a clean R session. Second, this design makes it waaaaaaaay easier to parallelise the execution. More on that later.</p>
<p>In any case, now that we’ve finished running the pipeline, let’s take a look at the state of our “spells” project folder:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_tree</span>(<span class="at">recurse =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
├── _targets
├── _targets.R
├── analysis.R
├── dice_pic.png
├── scholastic_pic.png
└── spells.csv</code></pre>
</div>
</div>
<p>There are three new things here. First, as expected, we have two image files <code>dice_pic.png</code> and <code>scholastic_pic.png</code>. These are the outputs produced by our analysis script. Yay, it worked! There’s also a <code>_targets</code> folder: this is the place where the targets package stashes all its metadata and stores copies of the built targets. I’ll talk more about the contents of this folder later, but just to give a sense of it now, here’s a sneak peek at what is stored in that folder:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_tree</span>(<span class="st">"_targets"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>_targets
├── meta
│   ├── meta
│   ├── process
│   └── progress
├── objects
│   ├── dice_dat
│   ├── dice_pic
│   ├── scholastic_clus
│   ├── scholastic_dat
│   ├── scholastic_pic
│   └── spells
└── user</code></pre>
</div>
</div>
</section>
<section id="when-the-project-changes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="when-the-project-changes">When the project changes</h3>
<p>Now that we’ve run the pipeline, let’s take another look at the network. The structure of it hasn’t changed, but all the targets are showing as “up to date”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>(<span class="at">targets_only =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-21697d58abce2053a245" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-21697d58abce2053a245">{"x":{"nodes":{"name":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"type":["stem","stem","stem","stem","stem","stem","stem"],"description":[null,null,null,null,null,null,null],"status":["uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate"],"seconds":[0.024,0.908,0.314,0.014,0.016,0.229,0.111],"bytes":[33486,65,302514,634,401,71,73966],"branches":[null,null,null,null,null,null,null],"label":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"color":["#354823","#354823","#354823","#354823","#354823","#354823","#354823"],"id":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells"],"level":[3,4,1,4,3,5,2],"shape":["dot","dot","dot","dot","dot","dot","dot"]},"edges":{"from":["scholastic_dat","spells","input","scholastic_clus","scholastic_dat","dice_dat","spells"],"to":["scholastic_clus","scholastic_dat","spells","scholastic_pic","scholastic_pic","dice_pic","dice_dat"],"arrows":["to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Stem"],"color":["#354823","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>If I call <code>tar_make()</code> again, essentially nothing happens. All the targets are up to date, so everything is skipped:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target input
✔ skipped target spells
✔ skipped target scholastic_dat
✔ skipped target dice_dat
✔ skipped target scholastic_clus
✔ skipped target dice_pic
✔ skipped target scholastic_pic
✔ skipped pipeline [0.069 seconds]</code></pre>
</div>
</div>
<p>Nice!</p>
<p>Actually, you know what? Now feels like a good time to show the full network, including all the functions that contribute to the pipeline…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-4929a56e939b13f92b78" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-4929a56e939b13f92b78">{"x":{"nodes":{"name":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"type":["stem","stem","stem","stem","stem","stem","stem","function","function","function","function","function"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate","uptodate"],"seconds":[0.024,0.908,0.314,0.014,0.016,0.229,0.111,null,null,null,null,null],"bytes":[33486,65,302514,634,401,71,73966,null,null,null,null,null],"branches":[null,null,null,null,null,null,null,null,null,null,null,null],"label":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"color":["#354823","#354823","#354823","#354823","#354823","#354823","#354823","#354823","#354823","#354823","#354823","#354823"],"id":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"level":[3,4,1,4,3,5,2,1,1,1,1,1],"shape":["dot","dot","dot","dot","dot","dot","dot","triangle","triangle","triangle","triangle","triangle"]},"edges":{"from":["scholastic_clusters","scholastic_dat","scholastic_data","spells","input","scholastic_clus","scholastic_dat","scholastic_plot","dice_dat","dice_plot","dice_data","spells"],"to":["scholastic_clus","scholastic_clus","scholastic_dat","scholastic_dat","spells","scholastic_pic","scholastic_pic","scholastic_pic","dice_pic","dice_pic","dice_dat","dice_dat"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Stem","Function"],"color":["#354823","#899DA4","#899DA4"],"shape":["dot","dot","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Now let’s suppose that, for whatever reason, I tinker with the plotting code for the “schools of magic” image. Perhaps I want to use a different colour scheme or something. So I go back into my code and change the code for the <code>scholastic_plot()</code> function, but <em>only</em> that function <em>&lt;edits the file behind the scenes…&gt;</em>. Let’s see what this does to the pipeline visualisation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-56457827ab1876f7c579" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-56457827ab1876f7c579">{"x":{"nodes":{"name":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"type":["stem","stem","stem","stem","stem","stem","stem","function","function","function","function","function"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["uptodate","uptodate","uptodate","uptodate","uptodate","outdated","uptodate","uptodate","outdated","uptodate","uptodate","uptodate"],"seconds":[0.024,0.908,0.314,0.014,0.016,0.229,0.111,null,null,null,null,null],"bytes":[33486,65,302514,634,401,71,73966,null,null,null,null,null],"branches":[null,null,null,null,null,null,null,null,null,null,null,null],"label":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"color":["#354823","#354823","#354823","#354823","#354823","#78B7C5","#354823","#354823","#78B7C5","#354823","#354823","#354823"],"id":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"level":[3,4,1,4,3,5,2,1,1,1,1,1],"shape":["dot","dot","dot","dot","dot","dot","dot","triangle","triangle","triangle","triangle","triangle"]},"edges":{"from":["scholastic_clusters","scholastic_dat","scholastic_data","spells","input","scholastic_clus","scholastic_dat","scholastic_plot","dice_dat","dice_plot","dice_data","spells"],"to":["scholastic_clus","scholastic_clus","scholastic_dat","scholastic_dat","spells","scholastic_pic","scholastic_pic","scholastic_pic","dice_pic","dice_pic","dice_dat","dice_dat"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Stem","Function"],"color":["#354823","#78B7C5","#899DA4","#899DA4"],"shape":["dot","dot","dot","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Not only does targets detect that the function has been altered, it also recognises that the <code>scholastic_pic</code> target (and only that target) is now outdated:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_outdated</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "scholastic_pic"</code></pre>
</div>
</div>
<p>Taking this a little further, suppose I also decide to tinker with the <code>dice_data()</code> function <em>&lt;edits the file again…&gt;</em>. Perhaps I’ve decided that actually I would like the plot to count every <em>instance</em> of a dice roll description in each spell, not merely the unique instances as the previous version did. Let’s see what our network visualisation looks like now:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-26b22985179f0d812c91" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-26b22985179f0d812c91">{"x":{"nodes":{"name":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"type":["stem","stem","stem","stem","stem","stem","stem","function","function","function","function","function"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["outdated","outdated","uptodate","uptodate","uptodate","outdated","uptodate","uptodate","outdated","outdated","uptodate","uptodate"],"seconds":[0.024,0.908,0.314,0.014,0.016,0.229,0.111,null,null,null,null,null],"bytes":[33486,65,302514,634,401,71,73966,null,null,null,null,null],"branches":[null,null,null,null,null,null,null,null,null,null,null,null],"label":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"color":["#78B7C5","#78B7C5","#354823","#354823","#354823","#78B7C5","#354823","#354823","#78B7C5","#78B7C5","#354823","#354823"],"id":["dice_dat","dice_pic","input","scholastic_clus","scholastic_dat","scholastic_pic","spells","scholastic_data","scholastic_plot","dice_data","scholastic_clusters","dice_plot"],"level":[3,4,1,4,3,5,2,1,1,1,1,1],"shape":["dot","dot","dot","dot","dot","dot","dot","triangle","triangle","triangle","triangle","triangle"]},"edges":{"from":["scholastic_clusters","scholastic_dat","scholastic_data","spells","input","scholastic_clus","scholastic_dat","scholastic_plot","dice_dat","dice_plot","dice_data","spells"],"to":["scholastic_clus","scholastic_clus","scholastic_dat","scholastic_dat","spells","scholastic_pic","scholastic_pic","scholastic_pic","dice_pic","dice_pic","dice_dat","dice_dat"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Up to date","Stem","Function"],"color":["#78B7C5","#354823","#899DA4","#899DA4"],"shape":["dot","dot","dot","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>That makes sense too: the <code>dice_data()</code> function affects the <code>dice_dat</code> target, but that also has implications for the <code>dice_pic</code> target because it depends on <code>dice_dat</code>. So now our list of outdated targets looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_outdated</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "scholastic_pic" "dice_pic"       "dice_dat"      </code></pre>
</div>
</div>
<p>When we re-run the pipeline this time, those three targets (and only those three targets) are rebuilt. The others are skipped:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target input
✔ skipped target spells
✔ skipped target scholastic_dat
▶ dispatched target dice_dat
● completed target dice_dat [0.03 seconds, 35.004 kilobytes]
✔ skipped target scholastic_clus
▶ dispatched target dice_pic
● completed target dice_pic [0.989 seconds, 65 bytes]
▶ dispatched target scholastic_pic
● completed target scholastic_pic [0.219 seconds, 71 bytes]
▶ ended pipeline [1.584 seconds]</code></pre>
</div>
</div>
<p>This, as you might imagine, is extremely useful in situations where you have a project that involves hundreds of analyses and figures that take a really long time to execute if you re-run everything from the beginning… but all you actually want to do is change the fontsize on figure 312.</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./spells-cache/dice_pic_2.png" class="img-fluid figure-img"></p>
<figcaption>dice_pic_2.png</figcaption>
</figure>
</div>
</div><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./spells-cache/scholastic_pic_2.png" class="img-fluid figure-img"></p>
<figcaption>scholastic_pic_2.png</figcaption>
</figure>
</div>
</div></div>
</section>
<section id="epilogue" class="level3">
<h3 class="anchored" data-anchor-id="epilogue">Epilogue</h3>
<p>For a first attempt at using targets, I’m not unhappy with this. It did what I needed it to do, and I was able to understand the basic structure of the package.</p>
<p>But there are some limitations. One thing that really bothers me is the way I handled the ggplot code. My thinking at the time was based on the thinking that real life analysis pipelines often have some <em>very</em> slow ggplot2 code, but the slow part is not the construction of the object itself, but rather the build, render, and draw stages. It’s not much of an issue in this specific example because everything is runs fast, but you can see why I had this worry by looking at what <code>benchplot()</code> has to say about the plots I created here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_load</span>(<span class="fu">c</span>(scholastic_dat, scholastic_clus))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">benchplot</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(scholastic_dat, <span class="fu">aes</span>(school, class, <span class="at">fill =</span> count)) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_dendro</span>(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">clust =</span> scholastic_clus<span class="sc">$</span>school,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">guide =</span> <span class="fu">guide_axis_dendro</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">position =</span> <span class="st">"top"</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_dendro</span>(</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">clust =</span> scholastic_clus<span class="sc">$</span>class,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_equal</span>()</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       step user.self sys.self elapsed
1 construct     0.018    0.001   0.018
2     build     0.037    0.000   0.038
3    render     0.047    0.002   0.046
4      draw     0.028    0.000   0.028
5     TOTAL     0.130    0.003   0.130</code></pre>
</div>
</div>
<p>Even in this example, where there isn’t very much that needs to be drawn to the graphics device, constructing the plot isn’t the step that takes the most time. So it makes very little sense to treat the plot specification (i.e., the <code>gg</code> plot object) as the terminal target of a plotting pipeline, because 90% of the compute time takes place <em>after</em> the <code>gg</code> object is specified (this is even more obvious when you have a scatterplot that needs to draw millions of dots to the canvas).</p>
<p>Having been burned by this in the past, I made the decision that my plotting target would encapsulate <em>all</em> stages in the plot rendering process. Only once the image has been written to a file would my plot target be deemed complete. As far as it goes, this is very sensible reasoning, but in retrospect I think it might have made a lot more sense to split the plotting target into stages. Saving the <code>gg</code> object as an intermediate target (and possibly other stages of the plot construction too) might have been sensible. It might seem like I’m being weirdly nitpicky, but my motivation here is very practical: I have a couple of projects where rerunning the analysis very time-consuming, and the biggest bottleneck (by far) is rendering and drawing some very unpleasant <code>gg</code> objects. I’ve been using a variety of tricks to work around this issue, none of which have been satisfying.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Targets offers a much cleaner solution to my problem, but it’s clear to me just from this toy exercise that I will need to be careful about how I set up targets for these analysis pipelines.</p>
<p>Still, it seems very clear to me that the problem can be solved with targets. My toy example is a kind of worst case solution… if all else fails, I can define the output image itself as the the target to be built. From that perspective, mission accomplished babes.</p>
<p><br><br></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./img/joanna-kosinska-B6yDtYs2IgY-unsplash.jpg" class="img-fluid figure-img"></p>
<figcaption>An even more lightweight blog</figcaption>
</figure>
</div>
<p><br></p>
</section>
</section>
<section id="story-2-building-a-blog" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="story-2-building-a-blog">Story 2: Building a blog</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set_knitr_dir</span>(<span class="st">"liteblog"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Okay, so the first project went better than I’d hoped. Shall we try something different then? This time around I decided I’d be a little more ambitious, and attempted to write a lightweight blogging tool using <a href="https://yihui.org/litedown/">litedown</a> as a drop-in replacement for R markdown or quarto, and using targets to manage the build process for the site as a whole. I had two reasons for picking this as my second attempt. First, personal preference: I seem to have developed a habit for rolling my own half-arsed blogging tools. A very long time ago I wrote a bad blogging package called <a href="https://caladown.djnavarro.net/">caladown</a> that I would not recommend anyone use ever, and about a about a year ago I repeated the foolishness over my summer break when I got bored and built a very silly <a href="https://knitr-11ty.djnavarro.net/">blog based on knitr and eleventy</a>, for literally no reason. Neither exercise was particularly useful, but both were fun.</p>
<p>The second reason for choosing this project is a little more serious. Unlike a simple analysis pipeline, there are a lot of details about the blog you don’t know in advance. You don’t know what the files will be called, you don’t know how many of them there will be, and so on. On top of that, even if you are able to write a target for “build a blog post”, you will need to build dozens or hundreds of tiny variations of the same target. There is <em>no way in hell</em> anyone wants to hand-code a targets pipeline for this situation: instead, we’ll need a mechanism for defining and building targets on the fly, rather than trying to specify all the targets in advance.</p>
<p>In other words, we’ll need to think about <a href="https://books.ropensci.org/targets/dynamic.html">dynamic branching</a>.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<section id="designing-the-blog" class="level3">
<h3 class="anchored" data-anchor-id="designing-the-blog">Designing the blog</h3>
<p>Just like last time, before we talk about the targets pipeline, it’s helpful to understand the rest of the project. After a bit of thought, I decided that a “liteblog” project would have a structure that looks something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_tree</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
├── _liteblog-footer.html
├── _liteblog-header.html
├── _liteblog.R
├── _liteblog.css
├── _targets.R
└── source
    ├── 404.rmd
    ├── _001_hello-cruel-world.rmd
    ├── _002_blog-object.rmd
    └── index.rmd</code></pre>
</div>
</div>
<p>This is what a clean project looks like <em>before</em> the blog has been built. Inside the <code>source</code> folder there are four R markdown documents, corresponding to the four HTML documents that will be created when the site is built. Specifically:<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<ul>
<li><code>index.rmd</code> becomes the blog homepage <code>index.html</code></li>
<li><code>404.rmd</code> becomes the 404 page <code>404.html</code></li>
<li><code>_001_hello-cruel-world.rmd</code> becomes <code>/001/hello-cruel-world/index.html</code></li>
<li><code>_002_blog-object.rmd</code> becomes <code>/002/blog-object/index.html</code></li>
</ul>
<p>The other files are used to define blog structure, style, and build process:</p>
<ul>
<li><code>_liteblog-header.html</code> provides HTML for the blog navbar</li>
<li><code>_liteblog-footer.html</code> provides HTML for the blog footer</li>
<li><code>_liteblog.css</code> provides the visual styling</li>
<li><code>_liteblog.R</code> supplies an <a href="https://r6.r-lib.org/">R6</a> class called <code>Liteblog</code> used to configure the blog</li>
<li><code>_targets.R</code> defines the build process</li>
</ul>
<p>The header, footer, and css files aren’t very important for our purposes, and neither is the content of the R markdown files. All the heavy lifting is done by <code>_liteblog.R</code> and <code>_targets.R</code>. I’ll talk about each of these in turn.</p>
</section>
<section id="the-liteblog-class" class="level3">
<h3 class="anchored" data-anchor-id="the-liteblog-class">The Liteblog class</h3>
<p>For reasons that I have already forgotten, I made a decision to implement the blogging tool as an R6 class. This blog post isn’t the place to talk about how R6 works, but conveniently <a href="https://adv-r.hadley.nz/r6.html">Hadley already did this better than I could</a> so now I don’t have to. Even more conveniently, it doesn’t matter too much for this post if you don’t already know R6. But for those who do, here’s the code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_liteblog.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>Liteblog <span class="ot">&lt;-</span> R6<span class="sc">::</span><span class="fu">R6Class</span>(</span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="at">classname =</span> <span class="st">"Liteblog"</span>,</span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb38-4"><a href="#cb38-4"></a>    </span>
<span id="cb38-5"><a href="#cb38-5"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">root =</span> <span class="st">"."</span>,</span>
<span id="cb38-6"><a href="#cb38-6"></a>                          <span class="at">source =</span> <span class="st">"source"</span>,</span>
<span id="cb38-7"><a href="#cb38-7"></a>                          <span class="at">output =</span> <span class="st">"site"</span>,</span>
<span id="cb38-8"><a href="#cb38-8"></a>                          <span class="at">url =</span> <span class="cn">NULL</span>) {</span>
<span id="cb38-9"><a href="#cb38-9"></a>      self<span class="sc">$</span>root <span class="ot">&lt;-</span> root</span>
<span id="cb38-10"><a href="#cb38-10"></a>      self<span class="sc">$</span>source <span class="ot">&lt;-</span> source</span>
<span id="cb38-11"><a href="#cb38-11"></a>      self<span class="sc">$</span>output <span class="ot">&lt;-</span> output</span>
<span id="cb38-12"><a href="#cb38-12"></a>      self<span class="sc">$</span>url <span class="ot">&lt;-</span> url</span>
<span id="cb38-13"><a href="#cb38-13"></a>    },</span>
<span id="cb38-14"><a href="#cb38-14"></a>    </span>
<span id="cb38-15"><a href="#cb38-15"></a>    <span class="at">root =</span> <span class="cn">NULL</span>,</span>
<span id="cb38-16"><a href="#cb38-16"></a>    <span class="at">source =</span> <span class="cn">NULL</span>,</span>
<span id="cb38-17"><a href="#cb38-17"></a>    <span class="at">output =</span> <span class="cn">NULL</span>,</span>
<span id="cb38-18"><a href="#cb38-18"></a>    <span class="at">url =</span> <span class="cn">NULL</span>,</span>
<span id="cb38-19"><a href="#cb38-19"></a>    <span class="at">pattern =</span> <span class="st">"[.][rR]?md$"</span>,</span>
<span id="cb38-20"><a href="#cb38-20"></a>    </span>
<span id="cb38-21"><a href="#cb38-21"></a>    <span class="at">find_posts =</span> <span class="cf">function</span>() {</span>
<span id="cb38-22"><a href="#cb38-22"></a>      files <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(</span>
<span id="cb38-23"><a href="#cb38-23"></a>        <span class="at">path =</span> fs<span class="sc">::</span><span class="fu">path</span>(self<span class="sc">$</span>root, self<span class="sc">$</span>source),</span>
<span id="cb38-24"><a href="#cb38-24"></a>        <span class="at">recurse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-25"><a href="#cb38-25"></a>        <span class="at">regexp =</span> self<span class="sc">$</span>pattern,</span>
<span id="cb38-26"><a href="#cb38-26"></a>        <span class="at">type =</span> <span class="st">"file"</span></span>
<span id="cb38-27"><a href="#cb38-27"></a>      )</span>
<span id="cb38-28"><a href="#cb38-28"></a>      <span class="fu">unname</span>(<span class="fu">unclass</span>(files))</span>
<span id="cb38-29"><a href="#cb38-29"></a>    },</span>
<span id="cb38-30"><a href="#cb38-30"></a>    </span>
<span id="cb38-31"><a href="#cb38-31"></a>    <span class="at">find_static =</span> <span class="cf">function</span>() {</span>
<span id="cb38-32"><a href="#cb38-32"></a>      files <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(</span>
<span id="cb38-33"><a href="#cb38-33"></a>        <span class="at">path =</span> fs<span class="sc">::</span><span class="fu">path</span>(self<span class="sc">$</span>root, self<span class="sc">$</span>source),</span>
<span id="cb38-34"><a href="#cb38-34"></a>        <span class="at">recurse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-35"><a href="#cb38-35"></a>        <span class="at">regexp =</span> self<span class="sc">$</span>pattern,</span>
<span id="cb38-36"><a href="#cb38-36"></a>        <span class="at">invert =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-37"><a href="#cb38-37"></a>        <span class="at">all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-38"><a href="#cb38-38"></a>        <span class="at">type =</span> <span class="st">"file"</span></span>
<span id="cb38-39"><a href="#cb38-39"></a>      )</span>
<span id="cb38-40"><a href="#cb38-40"></a>      <span class="fu">unname</span>(<span class="fu">unclass</span>(files))</span>
<span id="cb38-41"><a href="#cb38-41"></a>    },</span>
<span id="cb38-42"><a href="#cb38-42"></a>    </span>
<span id="cb38-43"><a href="#cb38-43"></a>    <span class="at">fuse_post =</span> <span class="cf">function</span>(file, ...) {</span>
<span id="cb38-44"><a href="#cb38-44"></a>      output_path <span class="ot">&lt;-</span> litedown<span class="sc">::</span><span class="fu">fuse</span>(file)</span>
<span id="cb38-45"><a href="#cb38-45"></a>      output_file <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_file</span>(output_path)</span>
<span id="cb38-46"><a href="#cb38-46"></a>      <span class="cf">if</span> (stringr<span class="sc">::</span><span class="fu">str_detect</span>(output_file, <span class="st">"^_"</span>)) {</span>
<span id="cb38-47"><a href="#cb38-47"></a>        destination <span class="ot">&lt;-</span> output_file <span class="sc">|&gt;</span></span>
<span id="cb38-48"><a href="#cb38-48"></a>          stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">"_"</span>, <span class="st">"/"</span>) <span class="sc">|&gt;</span></span>
<span id="cb38-49"><a href="#cb38-49"></a>          stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.html$"</span>, <span class="st">"/index.html"</span>) <span class="sc">|&gt;</span></span>
<span id="cb38-50"><a href="#cb38-50"></a>          stringr<span class="sc">::</span><span class="fu">str_replace</span>(<span class="st">"^"</span>, <span class="fu">paste0</span>(self<span class="sc">$</span>output, <span class="st">"/"</span>))</span>
<span id="cb38-51"><a href="#cb38-51"></a>      } <span class="cf">else</span> {</span>
<span id="cb38-52"><a href="#cb38-52"></a>        destination <span class="ot">&lt;-</span> <span class="fu">paste0</span>(self<span class="sc">$</span>output, <span class="st">"/"</span>, output_file)</span>
<span id="cb38-53"><a href="#cb38-53"></a>      }</span>
<span id="cb38-54"><a href="#cb38-54"></a>      destination <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(self<span class="sc">$</span>root, destination)</span>
<span id="cb38-55"><a href="#cb38-55"></a>      fs<span class="sc">::</span><span class="fu">dir_create</span>(fs<span class="sc">::</span><span class="fu">path_dir</span>(destination))</span>
<span id="cb38-56"><a href="#cb38-56"></a>      fs<span class="sc">::</span><span class="fu">file_move</span>(output_path, destination)</span>
<span id="cb38-57"><a href="#cb38-57"></a>    },</span>
<span id="cb38-58"><a href="#cb38-58"></a>    </span>
<span id="cb38-59"><a href="#cb38-59"></a>    <span class="at">copy_static =</span> <span class="cf">function</span>(file) {</span>
<span id="cb38-60"><a href="#cb38-60"></a>      destination <span class="ot">&lt;-</span> file <span class="sc">|&gt;</span></span>
<span id="cb38-61"><a href="#cb38-61"></a>        stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb38-62"><a href="#cb38-62"></a>          <span class="at">pattern =</span> <span class="fu">paste0</span>(<span class="st">"/"</span>, self<span class="sc">$</span>source, <span class="st">"/"</span>),</span>
<span id="cb38-63"><a href="#cb38-63"></a>          <span class="at">replacement =</span> <span class="fu">paste0</span>(<span class="st">"/"</span>, self<span class="sc">$</span>output, <span class="st">"/"</span>)</span>
<span id="cb38-64"><a href="#cb38-64"></a>        )</span>
<span id="cb38-65"><a href="#cb38-65"></a>      fs<span class="sc">::</span><span class="fu">dir_create</span>(fs<span class="sc">::</span><span class="fu">path_dir</span>(destination))</span>
<span id="cb38-66"><a href="#cb38-66"></a>      fs<span class="sc">::</span><span class="fu">file_copy</span>(</span>
<span id="cb38-67"><a href="#cb38-67"></a>        <span class="at">path =</span> file,</span>
<span id="cb38-68"><a href="#cb38-68"></a>        <span class="at">new_path =</span> destination,</span>
<span id="cb38-69"><a href="#cb38-69"></a>        <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb38-70"><a href="#cb38-70"></a>      )</span>
<span id="cb38-71"><a href="#cb38-71"></a>    }</span>
<span id="cb38-72"><a href="#cb38-72"></a>  )</span>
<span id="cb38-73"><a href="#cb38-73"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>It’s… honestly not that great.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> It is fit for purpose, so to speak, but if I were ever intending to use this in real life I’d want to give it a lot more love than I have to date. Nevertheless, just to give you a sense of how it works, I’ll create a new blog object by calling <code>Liteblog$new()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>blog <span class="ot">&lt;-</span> Liteblog<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>blog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Liteblog&gt;
  Public:
    clone: function (deep = FALSE) 
    copy_static: function (file) 
    find_posts: function () 
    find_static: function () 
    fuse_post: function (file, ...) 
    initialize: function (root = ".", source = "source", output = "site", url = NULL) 
    output: site
    pattern: [.][rR]?md$
    root: .
    source: source
    url: NULL</code></pre>
</div>
</div>
<p>Ignoring the boring parts of this output, you can see that this <code>blog</code> object has four methods that will get used when the site gets built by our targets pipeline:</p>
<ul>
<li><code>$find_posts()</code> detects R markdown documents in the source folder</li>
<li><code>$find_static()</code> detects other files in the source folder</li>
<li><code>$fuse_post()</code> converts an R markdown file to HTML in the output folder</li>
<li><code>$copy_static()</code> copies a file to the output folder</li>
</ul>
<p>There’s not much to be gained by diving very deep into these functions, but as an example, here’s what you would do to discover all the R markdown posts in this project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>blog<span class="sc">$</span><span class="fu">find_posts</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "./source/404.rmd"                   
[2] "./source/_001_hello-cruel-world.rmd"
[3] "./source/_002_blog-object.rmd"      
[4] "./source/index.rmd"                 </code></pre>
</div>
</div>
<p>This provides the core blogging toolkit that I’ll now use when writing my target pipeline. It’s <em>extremely</em> bare bones, and not very customisable, but of course my intention here isn’t to build a proper blogging platform. It’s just a toy that I can play with when building a more complex build pipeline. Speaking of which…</p>
</section>
<section id="the-build-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="the-build-pipeline">The build pipeline</h3>
<p>The <code>_targets.R</code> file for this project is a little more complicated than the one I used for the D&amp;D spells plots, and will take a bit of effort to unpack all of it. Let’s start by looking at the file as a whole:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_targets.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="fu">tar_source</span>(<span class="st">"_liteblog.R"</span>)</span>
<span id="cb43-3"><a href="#cb43-3"></a></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="fu">list</span>(</span>
<span id="cb43-5"><a href="#cb43-5"></a>  </span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="co"># define blog configuration</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-8"><a href="#cb43-8"></a>    <span class="at">name =</span> blog,</span>
<span id="cb43-9"><a href="#cb43-9"></a>    <span class="at">command =</span> Liteblog<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb43-10"><a href="#cb43-10"></a>      <span class="at">root =</span> rprojroot<span class="sc">::</span><span class="fu">find_root</span>(</span>
<span id="cb43-11"><a href="#cb43-11"></a>        rprojroot<span class="sc">::</span><span class="fu">has_file</span>(<span class="st">"_liteblog.R"</span>)</span>
<span id="cb43-12"><a href="#cb43-12"></a>      ),</span>
<span id="cb43-13"><a href="#cb43-13"></a>      <span class="at">source =</span> <span class="st">"source"</span>,</span>
<span id="cb43-14"><a href="#cb43-14"></a>      <span class="at">output =</span> <span class="st">"site"</span>,</span>
<span id="cb43-15"><a href="#cb43-15"></a>      <span class="at">url =</span> <span class="st">"liteblog.djnavarro.net"</span></span>
<span id="cb43-16"><a href="#cb43-16"></a>    )</span>
<span id="cb43-17"><a href="#cb43-17"></a>  ),</span>
<span id="cb43-18"><a href="#cb43-18"></a>  </span>
<span id="cb43-19"><a href="#cb43-19"></a>  <span class="co"># track configuration files</span></span>
<span id="cb43-20"><a href="#cb43-20"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-21"><a href="#cb43-21"></a>    <span class="at">name =</span> blog_rds, </span>
<span id="cb43-22"><a href="#cb43-22"></a>    <span class="at">command =</span> <span class="fu">saveRDS</span>(blog, <span class="at">file =</span> <span class="st">"_liteblog.rds"</span>), </span>
<span id="cb43-23"><a href="#cb43-23"></a>    <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb43-24"><a href="#cb43-24"></a>  ),</span>
<span id="cb43-25"><a href="#cb43-25"></a>  <span class="fu">tar_target</span>(blog_css, <span class="st">"_liteblog.css"</span>, <span class="at">format =</span> <span class="st">"file"</span>),</span>
<span id="cb43-26"><a href="#cb43-26"></a>  <span class="fu">tar_target</span>(blog_hdr, <span class="st">"_liteblog-header.html"</span>, <span class="at">format =</span> <span class="st">"file"</span>),</span>
<span id="cb43-27"><a href="#cb43-27"></a>  <span class="fu">tar_target</span>(blog_ftr, <span class="st">"_liteblog-footer.html"</span>, <span class="at">format =</span> <span class="st">"file"</span>),</span>
<span id="cb43-28"><a href="#cb43-28"></a>  </span>
<span id="cb43-29"><a href="#cb43-29"></a>  <span class="co"># detect file paths (always run)</span></span>
<span id="cb43-30"><a href="#cb43-30"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-31"><a href="#cb43-31"></a>    <span class="at">name =</span> post_paths, </span>
<span id="cb43-32"><a href="#cb43-32"></a>    <span class="at">command =</span> blog<span class="sc">$</span><span class="fu">find_posts</span>(), </span>
<span id="cb43-33"><a href="#cb43-33"></a>    <span class="at">cue =</span> <span class="fu">tar_cue</span>(<span class="st">"always"</span>)</span>
<span id="cb43-34"><a href="#cb43-34"></a>  ),</span>
<span id="cb43-35"><a href="#cb43-35"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-36"><a href="#cb43-36"></a>    <span class="at">name =</span> static_paths, </span>
<span id="cb43-37"><a href="#cb43-37"></a>    <span class="at">command =</span> blog<span class="sc">$</span><span class="fu">find_static</span>(), </span>
<span id="cb43-38"><a href="#cb43-38"></a>    <span class="at">cue =</span> <span class="fu">tar_cue</span>(<span class="st">"always"</span>)</span>
<span id="cb43-39"><a href="#cb43-39"></a>  ),</span>
<span id="cb43-40"><a href="#cb43-40"></a>  </span>
<span id="cb43-41"><a href="#cb43-41"></a>  <span class="co"># specify file targets</span></span>
<span id="cb43-42"><a href="#cb43-42"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-43"><a href="#cb43-43"></a>    <span class="at">name =</span> post_files, </span>
<span id="cb43-44"><a href="#cb43-44"></a>    <span class="at">command =</span> post_paths, </span>
<span id="cb43-45"><a href="#cb43-45"></a>    <span class="at">pattern =</span> <span class="fu">map</span>(post_paths), </span>
<span id="cb43-46"><a href="#cb43-46"></a>    <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb43-47"><a href="#cb43-47"></a>  ),</span>
<span id="cb43-48"><a href="#cb43-48"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-49"><a href="#cb43-49"></a>    <span class="at">name =</span> static_files, </span>
<span id="cb43-50"><a href="#cb43-50"></a>    <span class="at">command =</span> static_paths, </span>
<span id="cb43-51"><a href="#cb43-51"></a>    <span class="at">pattern =</span> <span class="fu">map</span>(static_paths), </span>
<span id="cb43-52"><a href="#cb43-52"></a>    <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb43-53"><a href="#cb43-53"></a>  ),</span>
<span id="cb43-54"><a href="#cb43-54"></a>  </span>
<span id="cb43-55"><a href="#cb43-55"></a>  <span class="co"># fuse targets depend on blog configuration files</span></span>
<span id="cb43-56"><a href="#cb43-56"></a>  <span class="co"># copy targets don't need dependencies</span></span>
<span id="cb43-57"><a href="#cb43-57"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-58"><a href="#cb43-58"></a>    <span class="at">name =</span> post_fuse,</span>
<span id="cb43-59"><a href="#cb43-59"></a>    <span class="at">command =</span> blog<span class="sc">$</span><span class="fu">fuse_post</span>(</span>
<span id="cb43-60"><a href="#cb43-60"></a>      post_files,</span>
<span id="cb43-61"><a href="#cb43-61"></a>      blog_css,</span>
<span id="cb43-62"><a href="#cb43-62"></a>      blog_hdr,</span>
<span id="cb43-63"><a href="#cb43-63"></a>      blog_ftr</span>
<span id="cb43-64"><a href="#cb43-64"></a>    ),</span>
<span id="cb43-65"><a href="#cb43-65"></a>    <span class="at">pattern =</span> <span class="fu">map</span>(post_files)</span>
<span id="cb43-66"><a href="#cb43-66"></a>  ),</span>
<span id="cb43-67"><a href="#cb43-67"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb43-68"><a href="#cb43-68"></a>    <span class="at">name =</span> static_copy, </span>
<span id="cb43-69"><a href="#cb43-69"></a>    <span class="at">command =</span> blog<span class="sc">$</span><span class="fu">copy_static</span>(static_files), </span>
<span id="cb43-70"><a href="#cb43-70"></a>    <span class="at">pattern =</span> <span class="fu">map</span>(static_files)</span>
<span id="cb43-71"><a href="#cb43-71"></a>  )</span>
<span id="cb43-72"><a href="#cb43-72"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Okay, yes, there’s a lot to unpack here as the young people<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> say. Not only is the code considerably longer than it was last time, I’m also making use of several targets features that weren’t present last time. Rather than try to explain it all at once, I’ll start by calling <code>tar_visnetwork()</code> again, focusing only on the targets that form the core of my build pipeline:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">allow =</span> <span class="fu">any_of</span>(<span class="fu">c</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"static_paths"</span>, <span class="st">"post_paths"</span>, <span class="st">"post_files"</span>, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"static_files"</span>, <span class="st">"post_fuse"</span>, <span class="st">"static_copy"</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-15cde5c072f26745d6fe" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-15cde5c072f26745d6fe">{"x":{"nodes":{"name":["post_files","post_fuse","post_paths","static_copy","static_files","static_paths"],"type":["pattern","pattern","stem","pattern","pattern","stem"],"description":[null,null,null,null,null,null],"status":["outdated","outdated","outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null,null,null],"bytes":[null,null,null,null,null,null],"branches":[null,null,null,null,null,null],"label":["post_files","post_fuse","post_paths","static_copy","static_files","static_paths"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["post_files","post_fuse","post_paths","static_copy","static_files","static_paths"],"level":[2,3,1,3,2,1],"shape":["square","square","dot","square","square","dot"]},"edges":{"from":["post_files","static_paths","post_paths","static_files"],"to":["post_fuse","static_files","post_files","static_copy"],"arrows":["to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Pattern","Stem"],"color":["#78B7C5","#899DA4","#899DA4"],"shape":["dot","square","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Let’s look at the top path first. It comprises the following steps:</p>
<ol type="1">
<li>Find the R markdown documents using <code>blog$find_posts()</code>. This creates a single build target, a character vector <code>post_paths</code>.</li>
<li>Declare that <em>every</em> R markdown document should be a tracked file. This is the role of the <code>post_files</code> target, but it’s a target comprised of several <em>branches</em>, and those branches are defined using a <em>pattern</em>. More on this later.</li>
<li>For each tracked R markdown document, use <code>blog$post_fuse()</code> to build the post and move the resulting HTML file to the correct location. This is the role of <code>post_fuse</code>, and again this is a pattern target comprised of many branches.</li>
</ol>
<p>The second path in the pipeline is analogous, but simpler:</p>
<ol type="1">
<li>The <code>static_paths</code> target tracks the paths to static files</li>
<li>The <code>static_files</code> target tracks the content of the static files</li>
<li>The <code>static_copy</code> target copies the static files to the output folder</li>
</ol>
<p>These two paths form the core of the build process, but it’s not the whole story. So let’s zoom out now and take a look at the complete network:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-eb4567664ad0e30c27d8" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-eb4567664ad0e30c27d8">{"x":{"nodes":{"name":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"type":["stem","stem","stem","stem","stem","pattern","pattern","stem","pattern","pattern","stem","object"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null,null,null,null,null,null,null,null,null],"bytes":[null,null,null,null,null,null,null,null,null,null,null,null],"branches":[null,null,null,null,null,null,null,null,null,null,null,null],"label":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"level":[2,1,1,1,3,4,5,3,5,4,3,1],"shape":["dot","dot","dot","dot","dot","square","square","dot","square","square","dot","triangleDown"]},"edges":{"from":["blog","blog","blog_css","blog_ftr","blog_hdr","post_files","static_paths","post_paths","blog","static_files","blog","Liteblog","blog"],"to":["static_paths","post_fuse","post_fuse","post_fuse","post_fuse","post_fuse","static_files","post_files","static_copy","static_copy","blog_rds","blog","post_paths"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem","Pattern","Object"],"color":["#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","square","triangleDown"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In this version, you can see that most of the build pipeline depends on the <code>blog</code> object: that makes sense because this is the R6 object that defines methods like <code>$find_posts()</code> and <code>$fuse_post()</code>, and it’s these functions that are called when the blog is built. Similarly, since <code>blog</code> is itself an instance of the <code>Liteblog</code> class, the class itself is an upstream dependency of <code>blog</code>.</p>
<p>The other four targets are less interesting. Three of them (<code>blog_css</code>, <code>blog_hdr</code>, and <code>blog_ftr</code>) are used to keep track of the style files (i.e.&nbsp;<code>_liteblog.css</code>, <code>_liteblog-header.html</code>, and <code>_liteblog-footer.html</code>), so that if any of those files are modified the it will trigger a rebuild of any target that uses those files. The fourth one, <code>blog_rds</code>, is a bit of an odd one and I’m not sure I like it: this target saves the <code>blog</code> object to an rds file. The reason for this is that it makes this object easier to access from <em>within</em> an R markdown post, by loading the file. This in turn makes it easier to construct the post listing on the home page. But I keep thinking there must be a better way to do this. Eh, whatever, it’s not a serious project.</p>
</section>
<section id="building-the-blog" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="building-the-blog">Building the blog</h3>
<p>At this point, you probably (hopefully!) have a general sense of what the build process looks like for this blog. I haven’t explained all the details yet, but I hope the gist is clear already. So let’s ignore those tiresome details for a little longer and call <code>tar_make()</code> to build the blog. The output is long, but there’s not much in there that we didn’t already see earlier with the D&amp;D spells project:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>▶ dispatched target blog
● completed target blog [0.003 seconds, 9.905 kilobytes]
▶ dispatched target blog_css
● completed target blog_css [0 seconds, 3.759 kilobytes]
▶ dispatched target blog_ftr
● completed target blog_ftr [0 seconds, 115 bytes]
▶ dispatched target blog_hdr
● completed target blog_hdr [0 seconds, 271 bytes]
▶ dispatched target static_paths
● completed target static_paths [0.032 seconds, 140 bytes]
▶ dispatched target post_paths
● completed target post_paths [0 seconds, 186 bytes]
▶ dispatched target blog_rds
● completed target blog_rds [0.003 seconds, 0 bytes]
▶ dispatched branch static_files_1725c3c24144eb91
● completed branch static_files_1725c3c24144eb91 [0.001 seconds, 0 bytes]
● completed pattern static_files 
▶ dispatched branch post_files_9bbb5ae3d1d3f95b
● completed branch post_files_9bbb5ae3d1d3f95b [0 seconds, 320 bytes]
▶ dispatched branch post_files_0a8225f176a1d698
● completed branch post_files_0a8225f176a1d698 [0 seconds, 4.667 kilobytes]
▶ dispatched branch post_files_2ed928ff2eafb31e
● completed branch post_files_2ed928ff2eafb31e [0 seconds, 2.451 kilobytes]
▶ dispatched branch post_files_b12b144c84b5b3a0
● completed branch post_files_b12b144c84b5b3a0 [0 seconds, 1.777 kilobytes]
● completed pattern post_files 
▶ dispatched branch static_copy_dfa803e4dbdaa48f
● completed branch static_copy_dfa803e4dbdaa48f [0.023 seconds, 173 bytes]
● completed pattern static_copy 
▶ dispatched branch post_fuse_c2dd6a62cc9d9565
● completed branch post_fuse_c2dd6a62cc9d9565 [0.62 seconds, 171 bytes]
▶ dispatched branch post_fuse_bb77d7e34f5b9d8d
● completed branch post_fuse_bb77d7e34f5b9d8d [0.654 seconds, 187 bytes]
▶ dispatched branch post_fuse_bb123c5d7a5d991e
● completed branch post_fuse_bb123c5d7a5d991e [0.092 seconds, 182 bytes]
▶ dispatched branch post_fuse_b2591b053d5431f7
● completed branch post_fuse_b2591b053d5431f7 [0.044 seconds, 173 bytes]
● completed pattern post_fuse 
▶ ended pipeline [1.663 seconds]</code></pre>
</div>
</div>
<p>Setting aside obvious questions like “what’s going on with all those weirdly named ‘branch’ targets like <code>post_files_bfe2f528519c0ff0</code>???”, the gist of this is pretty clear: everything has run smoothly and the blog has been built. In fact, you can see a live version of the blog, built from the source as it exists up to this point: it’s <a href="./site-1/index.html">here</a>). The project folder now looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_tree</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>.
├── _liteblog-footer.html
├── _liteblog-header.html
├── _liteblog.R
├── _liteblog.css
├── _liteblog.rds
├── _targets
│   ├── meta
│   │   ├── meta
│   │   ├── process
│   │   └── progress
│   ├── objects
│   │   ├── blog
│   │   ├── post_fuse_b2591b053d5431f7
│   │   ├── post_fuse_bb123c5d7a5d991e
│   │   ├── post_fuse_bb77d7e34f5b9d8d
│   │   ├── post_fuse_c2dd6a62cc9d9565
│   │   ├── post_paths
│   │   ├── static_copy_dfa803e4dbdaa48f
│   │   └── static_paths
│   └── user
├── _targets.R
├── site
│   ├── 001
│   │   └── hello-cruel-world
│   │       └── index.html
│   ├── 002
│   │   └── blog-object
│   │       └── index.html
│   ├── 404.html
│   └── index.html
└── source
    ├── 404.rmd
    ├── _001_hello-cruel-world.rmd
    ├── _002_blog-object.rmd
    └── index.rmd</code></pre>
</div>
</div>
<p>The key thing to notice here is that two new folders have been created: <code>_targets</code> stores metadata and tracked objects for the pipeline, and <code>site</code> contains the built website. Yay! It works!</p>
<p>So now let’s start digging into the details…</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./site-1/index.html"><img src="./img/liteblog-home.png" class="img-fluid figure-img" alt="the blog homepage"></a></p>
<figcaption>the blog homepage</figcaption>
</figure>
</div>
</div></div></section>
<section id="always-run-targets" class="level3">
<h3 class="anchored" data-anchor-id="always-run-targets">Always-run targets</h3>
<p>One of the problems I ran into pretty early in this project was how to monitor the source directory properly. It’s easy enough to scan a directory to find the files that live there: the <code>$find_posts()</code> and <code>$find_static()</code> methods for <code>Liteblog</code> objects do exactly this. But consider a target like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(post_paths, blog<span class="sc">$</span><span class="fu">find_posts</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This target stores a list of all R markdown posts, but it has only one dependency: the <code>blog</code> object itself. It is not dependent on the state of the source folder. It can’t be: a folder in the file system isn’t an R object. So, if the state of the folder changes (e.g., a new blog post is added), targets would have no way to know that the <code>post_paths</code> target needs to be updated.</p>
<p>A simple solution is to declare that the <code>post_paths</code> target must always be run whenever <code>tar_make()</code> is called. We can do this by using <a href="https://docs.ropensci.org/targets/reference/tar_cue.html"><code>tar_cue()</code></a>, and that’s why the actual target is defined like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> post_paths, </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command =</span> blog<span class="sc">$</span><span class="fu">find_posts</span>(), </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cue =</span> <span class="fu">tar_cue</span>(<span class="st">"always"</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A similar approach is taken when defining the <code>static_paths</code> target. These two targets are always executed at build time. What this means, in practice, is that even though I have just run <code>tar_make()</code> and haven’t changed any of the files since then, the network visualisation appears like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-af58166d53661c8cfb95" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-af58166d53661c8cfb95">{"x":{"nodes":{"name":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"type":["stem","stem","stem","stem","stem","pattern","pattern","stem","pattern","pattern","stem","object"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["uptodate","uptodate","uptodate","uptodate","uptodate","outdated","outdated","outdated","outdated","outdated","outdated","uptodate"],"seconds":[0.003,0,0,0,0.003,0,1.41,0,0.023,0.001,0.032,null],"bytes":[9905,3759,115,271,0,9215,713,186,173,0,140,null],"branches":[null,null,null,null,null,4,4,null,1,1,null,null],"label":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"color":["#354823","#354823","#354823","#354823","#354823","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#354823"],"id":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"level":[2,1,1,1,3,4,5,3,5,4,3,1],"shape":["dot","dot","dot","dot","dot","square","square","dot","square","square","dot","triangleDown"]},"edges":{"from":["blog","blog","blog_css","blog_ftr","blog_hdr","post_files","static_paths","post_paths","blog","static_files","blog","Liteblog","blog"],"to":["static_paths","post_fuse","post_fuse","post_fuse","post_fuse","post_fuse","static_files","post_files","static_copy","static_copy","blog_rds","blog","post_paths"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Stem","Pattern","Object"],"color":["#354823","#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","dot","square","triangleDown"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>As expected, <code>static_paths</code> and <code>post_paths</code> both show up as outdated targets, and so does everything downstream of those two. Again, this makes sense: until those two targets are re-run, the targets package has no way to know if the downstream targets will also need to be rebuilt. Consequently, calling <code>tar_outdated()</code> gives us this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_outdated</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "static_paths" "post_fuse"    "static_files" "post_files"  
[5] "static_copy"  "post_paths"  </code></pre>
</div>
</div>
<p>However, the fact that the downstream targets are flagged as outdated doesn’t mean these targets will need to be executed again. To see this, let’s call <code>tar_make()</code> again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
✔ skipped target blog_css
✔ skipped target blog_ftr
✔ skipped target blog_hdr
▶ dispatched target static_paths
● completed target static_paths [0.032 seconds, 140 bytes]
▶ dispatched target post_paths
● completed target post_paths [0 seconds, 186 bytes]
✔ skipped target blog_rds
✔ skipped branch static_files_1725c3c24144eb91
✔ skipped pattern static_files
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_b12b144c84b5b3a0
✔ skipped pattern post_files
✔ skipped branch static_copy_dfa803e4dbdaa48f
✔ skipped pattern static_copy
✔ skipped branch post_fuse_c2dd6a62cc9d9565
✔ skipped branch post_fuse_bb77d7e34f5b9d8d
✔ skipped branch post_fuse_bb123c5d7a5d991e
✔ skipped branch post_fuse_b2591b053d5431f7
✔ skipped pattern post_fuse
▶ ended pipeline [0.114 seconds]</code></pre>
</div>
</div>
<p>As expected, the <code>static_paths</code> and <code>post_paths</code> targets are both re-run, as instructed by <code>tar_cue("always")</code>. However, once those targets are completed, the targets package is smart enough to detect that nothing has actually changed. The <code>static_paths</code> and <code>post_paths</code> objects are exactly the same as they were previously, so there is no need to execute any of the downstream targets. In other words, at build time the blog will always check to see if the content in the source folder has changed, but if nothing has changed the fuse and copy targets are skipped.</p>
</section>
<section id="dynamic-branching" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="dynamic-branching">Dynamic branching</h3>
<p>The second design feature that caused me some grief was how to write a <code>_targets.R</code> file that would build every R markdown post in the source folder, even though I wouldn’t know in advance how many of those documents exist or what they would be called. As described in the last section, one part of the solution was to define the <code>post_paths</code> target, which would always be executed at build time, and would store the names of all the R markdown documents. I’ll use <a href="https://docs.ropensci.org/targets/reference/tar_read.html"><code>tar_read()</code></a> to pull these paths from targets storage:<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="cell column-page-right">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_read</span>(post_paths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/home/danielle/GitHub/djnavarro/blog/posts/2025-01-08_using-targets/liteblog/source/404.rmd"                   
[2] "/home/danielle/GitHub/djnavarro/blog/posts/2025-01-08_using-targets/liteblog/source/_001_hello-cruel-world.rmd"
[3] "/home/danielle/GitHub/djnavarro/blog/posts/2025-01-08_using-targets/liteblog/source/_002_blog-object.rmd"      
[4] "/home/danielle/GitHub/djnavarro/blog/posts/2025-01-08_using-targets/liteblog/source/index.rmd"                 </code></pre>
</div>
</div>
<p>Each of these corresponds to a file that needs to be tracked, in much the same way I treated <code>spells.csv</code> as a tracked file in the D&amp;D plots project. There are multiple ways you can do this in targets, but after a few different tries I decided to use <a href="https://books.ropensci.org/targets/dynamic.html">dynamic branching</a>, a trick in which a single target is split at build time into multiple distinct branches. For the liteblog project, I defined <code>post_file</code> like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_target</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> post_files, </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">command =</span> post_paths, </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern =</span> <span class="fu">map</span>(post_paths), </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"file"</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By including the argument <code>pattern = map(post_paths)</code>, I am telling targets to create a separate branch for <code>post_files</code> for every element in the <code>post_paths</code> vector. Specifically, since I’ve also set <code>format = "file"</code>, I’m instructing each of these branches to track the state of one of these files. If that file changes, the branch that tracks the file will become outdated and need to be rebuilt. To get a little more information about the branches, I can call <a href="https://docs.ropensci.org/targets/reference/tar_branches.html"><code>tar_branches()</code></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_branches</span>(post_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  post_files                  post_paths                 
  &lt;chr&gt;                       &lt;chr&gt;                      
1 post_files_9bbb5ae3d1d3f95b post_paths_b1b0e0a7d31afe4b
2 post_files_0a8225f176a1d698 post_paths_3444a4f5b2ff26a6
3 post_files_2ed928ff2eafb31e post_paths_b75d461c06347275
4 post_files_b12b144c84b5b3a0 post_paths_a853bb7ccac490b8</code></pre>
</div>
</div>
<p>Each branch corresponds to a single row in this table: the value of the <code>post_files</code> column records the name assigned by targets to that branch, and the value of the <code>post_paths</code> column assigns a name to the corresponding element of the <code>post_paths</code> target over which we have branched. These names aren’t particularly user-friendly, to be sure, but nevertheless my problem is solved.</p>
<p>To see how this dynamic branching plays out in practice, let’s see what happens when I modify the content of the blog in different ways.</p>
</section>
<section id="editing-an-existing-page" class="level3">
<h3 class="anchored" data-anchor-id="editing-an-existing-page">Editing an existing page</h3>
<p>Let’s modify the source for the 404 page. I’ll change it so that the title of the page now reads “404 PAGE NOT FOUND” rather than simply “404” as it had previously. Okay… <em><tweaks some="" files="" behind="" the="" scenes=""></tweaks></em>… yep, done. I’ve edited the file now.</p>
<p>How does this edit get picked up in the targets build process? This time around, I’ll build it in stages so that the output is a little easier to read. We can do this by asking <code>tar_make()</code> to build a specific target, rather than build the entire project. First, let’s build the <code>post_files</code> target again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>(post_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
▶ dispatched target post_paths
● completed target post_paths [0.033 seconds, 186 bytes]
▶ dispatched branch post_files_9bbb5ae3d1d3f95b
● completed branch post_files_9bbb5ae3d1d3f95b [0 seconds, 335 bytes]
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_b12b144c84b5b3a0
● completed pattern post_files 
▶ ended pipeline [0.101 seconds]</code></pre>
</div>
</div>
<p>As we hoped, we see that one (and only one) of the <code>post_files</code> branches has been rebuilt, specifically the one corresponding to the <code>404.rmd</code> file that I just edited. So far so good. Next, let’s see what happens when <code>post_fuse</code> is rebuilt:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>(post_fuse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
✔ skipped target blog_css
✔ skipped target blog_ftr
✔ skipped target blog_hdr
▶ dispatched target post_paths
● completed target post_paths [0.033 seconds, 186 bytes]
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_b12b144c84b5b3a0
✔ skipped pattern post_files
▶ dispatched branch post_fuse_c2dd6a62cc9d9565
● completed branch post_fuse_c2dd6a62cc9d9565 [0.12 seconds, 171 bytes]
✔ skipped branch post_fuse_bb77d7e34f5b9d8d
✔ skipped branch post_fuse_bb123c5d7a5d991e
✔ skipped branch post_fuse_b2591b053d5431f7
● completed pattern post_fuse 
▶ ended pipeline [0.242 seconds]</code></pre>
</div>
</div>
<p>Again, notice all the skipped targets. The only targets that are dispatched are <code>post_paths</code> (because we instructed that one to always run), and one branch of <code>post_fuse</code>. In other words, the only thing that happens here is that the outdated post gets rebuilt.</p>
<p>Yay!</p>
</section>
<section id="adding-new-pages" class="level3">
<h3 class="anchored" data-anchor-id="adding-new-pages">Adding new pages</h3>
<p>As the next check that the blog functionality is working as expected, let’s have a look at what happens when… <em><more tinkering="" behind="" the="" scenes=""></more></em>… two new blog posts are added to the <code>source</code> folder, along with a new static file:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>source
├── 404.rmd
├── _001_hello-cruel-world.rmd
├── _002_blog-object.rmd
├── _003_schools-of-magic.rmd
├── _004_spell-dice.rmd
├── data
│   └── spells.csv
└── index.rmd</code></pre>
</div>
</div>
<p>Again, I’ll do it in stages so that the output is a little easier to read:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>(post_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
▶ dispatched target post_paths
● completed target post_paths [0.037 seconds, 218 bytes]
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
▶ dispatched branch post_files_454f9b18b99302f6
● completed branch post_files_454f9b18b99302f6 [0 seconds, 11.136 kilobytes]
▶ dispatched branch post_files_b77b5ec03a0b7e01
● completed branch post_files_b77b5ec03a0b7e01 [0.001 seconds, 3.631 kilobytes]
✔ skipped branch post_files_b12b144c84b5b3a0
● completed pattern post_files 
▶ ended pipeline [0.117 seconds]</code></pre>
</div>
</div>
<p>The four existing R markdown files are skipped, as they are already being tracked and none of them have changed. The two new R markdown files are added, and we can see that the corresponding <code>post_files</code> branches have both been updated. We are now tracking these files.</p>
<p>Next, we build the pages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>(post_fuse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
✔ skipped target blog_css
✔ skipped target blog_ftr
✔ skipped target blog_hdr
▶ dispatched target post_paths
● completed target post_paths [0.034 seconds, 218 bytes]
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_454f9b18b99302f6
✔ skipped branch post_files_b77b5ec03a0b7e01
✔ skipped branch post_files_b12b144c84b5b3a0
✔ skipped pattern post_files
✔ skipped branch post_fuse_c2dd6a62cc9d9565
✔ skipped branch post_fuse_bb77d7e34f5b9d8d
✔ skipped branch post_fuse_bb123c5d7a5d991e
▶ dispatched branch post_fuse_f59600e87d9d07da
● completed branch post_fuse_f59600e87d9d07da [1.1 seconds, 185 bytes]
▶ dispatched branch post_fuse_a98becd61e7088dd
● completed branch post_fuse_a98becd61e7088dd [1.015 seconds, 183 bytes]
✔ skipped branch post_fuse_b2591b053d5431f7
● completed pattern post_fuse 
▶ ended pipeline [2.239 seconds]</code></pre>
</div>
</div>
<p>Again, works as expected. Most targets get skipped, and only the two new posts are built to HTML pages.</p>
<p>Finally, because we’ve added a new static file, I’ll now rebuild everything to ensure that this file gets copied over to the site correctly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
✔ skipped target blog_css
✔ skipped target blog_ftr
✔ skipped target blog_hdr
▶ dispatched target static_paths
● completed target static_paths [0.032 seconds, 159 bytes]
▶ dispatched target post_paths
● completed target post_paths [0 seconds, 218 bytes]
✔ skipped target blog_rds
✔ skipped branch static_files_1725c3c24144eb91
▶ dispatched branch static_files_cfb2777954f617d0
● completed branch static_files_cfb2777954f617d0 [0 seconds, 302.514 kilobytes]
● completed pattern static_files 
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_454f9b18b99302f6
✔ skipped branch post_files_b77b5ec03a0b7e01
✔ skipped branch post_files_b12b144c84b5b3a0
✔ skipped pattern post_files
✔ skipped branch static_copy_dfa803e4dbdaa48f
▶ dispatched branch static_copy_501faf107279df5b
● completed branch static_copy_501faf107279df5b [0.015 seconds, 173 bytes]
● completed pattern static_copy 
✔ skipped branch post_fuse_c2dd6a62cc9d9565
✔ skipped branch post_fuse_bb77d7e34f5b9d8d
✔ skipped branch post_fuse_bb123c5d7a5d991e
✔ skipped branch post_fuse_f59600e87d9d07da
✔ skipped branch post_fuse_a98becd61e7088dd
✔ skipped branch post_fuse_b2591b053d5431f7
✔ skipped pattern post_fuse
▶ ended pipeline [0.144 seconds]</code></pre>
</div>
</div>
<p>You can browse the built website, as it appears at this stage in the process, at the cached location <a href="./site-2/index.html">here</a>.</p>
</section>
<section id="editing-the-style-files" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="editing-the-style-files">Editing the style files</h3>
<p>There’s one last thing I want to check. Let’s suppose I created a light-themed version of the blog by editing <code>_liteblog.css</code>. Or, to be more accurate, let’s suppose I made a quick and dirty edit to the CSS file that almost creates a light theme but actually leaves a lot of weirdness unfixed because the author was too lazy to do it properly and frankly isn’t very strong at CSS.</p>
<p>Let’s see what this does to the network visualisation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-dc9b6b2f202c941e6590" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-dc9b6b2f202c941e6590">{"x":{"nodes":{"name":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"type":["stem","stem","stem","stem","stem","pattern","pattern","stem","pattern","pattern","stem","object"],"description":[null,null,null,null,null,null,null,null,null,null,null,null],"status":["uptodate","outdated","uptodate","uptodate","uptodate","outdated","outdated","outdated","outdated","outdated","outdated","uptodate"],"seconds":[0.003,0,0,0,0.003,0.001,2.115,0,0.015,0,0.032,null],"bytes":[9905,3759,115,271,0,14767,368,218,173,302514,159,null],"branches":[null,null,null,null,null,6,6,null,2,2,null,null],"label":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"color":["#354823","#78B7C5","#354823","#354823","#354823","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#354823"],"id":["blog","blog_css","blog_ftr","blog_hdr","blog_rds","post_files","post_fuse","post_paths","static_copy","static_files","static_paths","Liteblog"],"level":[2,1,1,1,3,4,5,3,5,4,3,1],"shape":["dot","dot","dot","dot","dot","square","square","dot","square","square","dot","triangleDown"]},"edges":{"from":["blog","blog","blog_css","blog_ftr","blog_hdr","post_files","static_paths","post_paths","blog","static_files","blog","Liteblog","blog"],"to":["static_paths","post_fuse","post_fuse","post_fuse","post_fuse","post_fuse","static_files","post_files","static_copy","static_copy","blog_rds","blog","post_paths"],"arrows":["to","to","to","to","to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Stem","Pattern","Object"],"color":["#354823","#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","dot","square","triangleDown"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Targets has detected the edit, but notice that there is a dependency between <code>blog_css</code> and <code>fuse_post</code>. This dependency is added because for this blog the CSS is embedded<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> within the HTML file at build time: as a consequence, editing the CSS means that <em>all</em> pages will need to be rebuilt. And indeed…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ skipped target blog
▶ dispatched target blog_css
● completed target blog_css [0 seconds, 3.759 kilobytes]
✔ skipped target blog_ftr
✔ skipped target blog_hdr
▶ dispatched target static_paths
● completed target static_paths [0.032 seconds, 159 bytes]
▶ dispatched target post_paths
● completed target post_paths [0 seconds, 218 bytes]
✔ skipped target blog_rds
✔ skipped branch static_files_1725c3c24144eb91
✔ skipped branch static_files_cfb2777954f617d0
✔ skipped pattern static_files
✔ skipped branch post_files_9bbb5ae3d1d3f95b
✔ skipped branch post_files_0a8225f176a1d698
✔ skipped branch post_files_2ed928ff2eafb31e
✔ skipped branch post_files_454f9b18b99302f6
✔ skipped branch post_files_b77b5ec03a0b7e01
✔ skipped branch post_files_b12b144c84b5b3a0
✔ skipped pattern post_files
✔ skipped branch static_copy_dfa803e4dbdaa48f
✔ skipped branch static_copy_501faf107279df5b
✔ skipped pattern static_copy
▶ dispatched branch post_fuse_c2dd6a62cc9d9565
● completed branch post_fuse_c2dd6a62cc9d9565 [0.229 seconds, 171 bytes]
▶ dispatched branch post_fuse_bb77d7e34f5b9d8d
● completed branch post_fuse_bb77d7e34f5b9d8d [0.761 seconds, 187 bytes]
▶ dispatched branch post_fuse_bb123c5d7a5d991e
● completed branch post_fuse_bb123c5d7a5d991e [0.149 seconds, 182 bytes]
▶ dispatched branch post_fuse_f59600e87d9d07da
● completed branch post_fuse_f59600e87d9d07da [0.674 seconds, 185 bytes]
▶ dispatched branch post_fuse_a98becd61e7088dd
● completed branch post_fuse_a98becd61e7088dd [1.053 seconds, 183 bytes]
▶ dispatched branch post_fuse_b2591b053d5431f7
● completed branch post_fuse_b2591b053d5431f7 [0.044 seconds, 173 bytes]
● completed pattern post_fuse 
▶ ended pipeline [3.052 seconds]</code></pre>
</div>
</div>
<p>…that’s exactly what happens. Again, you can browse the built website, horrible CSS failures and all, at the cached location <a href="./site-3/index.html">here</a>.</p>

<div class="no-row-height column-margin column-container"><div class="">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./site-3/index.html"><img src="./img/liteblog-home-2.png" class="img-fluid figure-img" alt="light-themed blog homepage"></a></p>
<figcaption>light-themed blog homepage</figcaption>
</figure>
</div>
</div></div></section>
<section id="epilogue-1" class="level3">
<h3 class="anchored" data-anchor-id="epilogue-1">Epilogue</h3>
<p>That… went about as well as could be expected, I suppose? This “liteblog” project was never intended to be a serious effort at writing a blogging tool, but it does actually work, and maybe one day I’ll use it for something. Probably not though. Having gotten as far as I have into building this, I can see a lot of design limitations that would cause difficulties if I ever tried to use it for real.</p>
<p>So what was the point? Well, I now have a basic understanding of litedown, and I have a better grasp of dynamic branching in targets. That’s a big win as far as I’m concerned.</p>
<p><br><br></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./img/kamran-gholami-20T7ctRArtA-unsplash.jpg" class="img-fluid figure-img"></p>
<figcaption>Multiple threads in parallel</figcaption>
</figure>
</div>
<p><br></p>
</section>
</section>
<section id="story-3-parallel-computing" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="story-3-parallel-computing">Story 3: Parallel computing</h2>
<p>For my third foray into targets – and the last one for this blog post – I wanted to take a look at how a targets pipeline can be distributed across multiple parallel threads. Happily, parallel computing is supported out of the box in targets, using the <a href="https://wlandau.github.io/crew/">crew</a> package to distribute the targets across multiple workers. This ended up being the smallest of my three projects, but there are a couple slightly different variations on how I looked at this, and I’ll go through them each in turn.</p>
<section id="minimal-version" class="level3">
<h3 class="anchored" data-anchor-id="minimal-version">Minimal version</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set_knitr_dir</span>(<span class="st">"threading1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As a very minimal implementation, consider this pipeline:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_targets.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb77-2"><a href="#cb77-2"></a><span class="fu">library</span>(crew)</span>
<span id="cb77-3"><a href="#cb77-3"></a></span>
<span id="cb77-4"><a href="#cb77-4"></a><span class="fu">tar_option_set</span>(<span class="at">controller =</span> <span class="fu">crew_controller_local</span>(<span class="at">workers =</span> <span class="dv">3</span>))</span>
<span id="cb77-5"><a href="#cb77-5"></a></span>
<span id="cb77-6"><a href="#cb77-6"></a><span class="fu">list</span>(</span>
<span id="cb77-7"><a href="#cb77-7"></a>  <span class="fu">tar_target</span>(wait1, <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)),</span>
<span id="cb77-8"><a href="#cb77-8"></a>  <span class="fu">tar_target</span>(wait2, <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)),</span>
<span id="cb77-9"><a href="#cb77-9"></a>  <span class="fu">tar_target</span>(wait3, <span class="fu">Sys.sleep</span>(<span class="dv">3</span>)),</span>
<span id="cb77-10"><a href="#cb77-10"></a>  <span class="fu">tar_target</span>(wait4, <span class="fu">Sys.sleep</span>(<span class="dv">4</span>))</span>
<span id="cb77-11"><a href="#cb77-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There are four targets here, and all they do is pause execution. If these were run serially, you would expect this to take about 10 seconds to complete. But that’s not what happens because I’m using <a href="https://wlandau.github.io/crew/reference/crew_controller_local.html"><code>crew_controller_local()</code></a> to define a controller that will split the processing across three parallel workers. Here’s what actually happens:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>▶ dispatched target wait1
▶ dispatched target wait2
▶ dispatched target wait3
● completed target wait1 [1.015 seconds, 44 bytes]
▶ dispatched target wait4
● completed target wait2 [2.01 seconds, 44 bytes]
● completed target wait3 [3.011 seconds, 44 bytes]
● completed target wait4 [4.004 seconds, 44 bytes]
▶ ended pipeline [6.962 seconds]</code></pre>
</div>
</div>
<p>Upon starting the job, the first three targets (<code>wait1</code>, <code>wait2</code>, and <code>wait3</code>) are dispatched to the three workers and they all start running concurrently. The fourth job (<code>wait4</code>) is placed on hold, and doesn’t start until the first of the three jobs finishes (<code>wait1</code>). Only then does the fourth job start. As the remaining jobs complete, the user is notified, and once they are all finalised targets reports that the pipeline is complete. You can get a high-level summary of the allocation of tasks across workers by calling <a href="https://docs.ropensci.org/targets/reference/tar_crew.html"><code>tar_crew()</code></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_crew</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  controller               worker seconds targets
  &lt;chr&gt;                    &lt;chr&gt;    &lt;dbl&gt;   &lt;int&gt;
1 e0ea4b4586b1458cc4d537c3 1         5.11       2
2 e0ea4b4586b1458cc4d537c3 2         2.10       1
3 e0ea4b4586b1458cc4d537c3 3         3.10       1</code></pre>
</div>
</div>
<p>As expected based on the intuitive description above, this output confirms that there’s one worker process that handled two of the targets, and one each handled by the other two.</p>
</section>
<section id="slightly-less-minimal-version" class="level3">
<h3 class="anchored" data-anchor-id="slightly-less-minimal-version">Slightly less minimal version</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set_knitr_dir</span>(<span class="st">"threading2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The previous example gives a general sense of how parallel execution works in a crew/targets pipeline, but – possibly because once upon a time I used <a href="https://callr.r-lib.org/">callr</a> to write my own R6 implementation of a multi-threaded <a href="../../posts/2022-12-22_queue/">queue</a>,<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> which piqued my curiosity about how these things play out – I found myself wanting a finer-grained description of what each of the workers is doing at each point in time.</p>
<p>As far as I can tell, neither targets nor crew provides an easy way to do this (edited to add: I later realised that <a href="https://docs.ropensci.org/targets/reference/tar_meta.html"><code>tar_meta()</code></a> provides a lot of what I need), so I wrote a slightly more elaborate version of the previous pipeline, in which the targets themselves keep track of the time at which execution starts and stops, as well as the pid of the R process in which they are being executed. In this version, there are three functions that do the work:</p>
<ul>
<li><code>startup()</code> is called to build the first target (<code>start</code>), and its primary job is to capture the system time at which execution of the first target begins</li>
<li><code>sleeper()</code> is used to build the <code>wait1</code>, <code>wait2</code>, <code>wait3</code>, and <code>wait4</code> targets. These targets are analogous to the wait targets in the original version, but they also capture information about when execution of these targets started and stopped</li>
<li><code>collate()</code> is called at the very end, and is used to construct the <code>trace</code> target. This target aggregates all the information from the other targets</li>
</ul>
<p>Here’s the entire code:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_targets.R</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="fu">library</span>(crew)</span>
<span id="cb83-3"><a href="#cb83-3"></a></span>
<span id="cb83-4"><a href="#cb83-4"></a><span class="fu">tar_option_set</span>(<span class="at">controller =</span> <span class="fu">crew_controller_local</span>(<span class="at">workers =</span> <span class="dv">3</span>))</span>
<span id="cb83-5"><a href="#cb83-5"></a></span>
<span id="cb83-6"><a href="#cb83-6"></a>sleeper <span class="ot">&lt;-</span> <span class="cf">function</span>(duration, pipeline_start, name) {</span>
<span id="cb83-7"><a href="#cb83-7"></a>  sleep_start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb83-8"><a href="#cb83-8"></a>  <span class="fu">Sys.sleep</span>(duration)</span>
<span id="cb83-9"><a href="#cb83-9"></a>  sleep_stop <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb83-10"><a href="#cb83-10"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb83-11"><a href="#cb83-11"></a>    <span class="at">name           =</span> name,</span>
<span id="cb83-12"><a href="#cb83-12"></a>    <span class="at">pipeline_start =</span> pipeline_start,</span>
<span id="cb83-13"><a href="#cb83-13"></a>    <span class="at">worker_pid     =</span> <span class="fu">Sys.getpid</span>(),</span>
<span id="cb83-14"><a href="#cb83-14"></a>    <span class="at">begins_at      =</span> <span class="fu">difftime</span>(sleep_start, pipeline_start),</span>
<span id="cb83-15"><a href="#cb83-15"></a>    <span class="at">finishes_at    =</span> <span class="fu">difftime</span>(sleep_stop, pipeline_start)</span>
<span id="cb83-16"><a href="#cb83-16"></a>  )</span>
<span id="cb83-17"><a href="#cb83-17"></a>}</span>
<span id="cb83-18"><a href="#cb83-18"></a></span>
<span id="cb83-19"><a href="#cb83-19"></a>startup <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb83-20"><a href="#cb83-20"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb83-21"><a href="#cb83-21"></a>    <span class="at">name =</span> <span class="st">"start"</span>,</span>
<span id="cb83-22"><a href="#cb83-22"></a>    <span class="at">pipeline_start =</span> <span class="fu">Sys.time</span>(),</span>
<span id="cb83-23"><a href="#cb83-23"></a>    <span class="at">worker_pid     =</span> <span class="fu">Sys.getpid</span>(),</span>
<span id="cb83-24"><a href="#cb83-24"></a>    <span class="at">begins_at      =</span> <span class="fu">as.difftime</span>(<span class="dv">0</span>, <span class="at">units =</span> <span class="st">"secs"</span>),</span>
<span id="cb83-25"><a href="#cb83-25"></a>    <span class="at">finishes_at    =</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), pipeline_start)</span>
<span id="cb83-26"><a href="#cb83-26"></a>  )</span>
<span id="cb83-27"><a href="#cb83-27"></a>}</span>
<span id="cb83-28"><a href="#cb83-28"></a></span>
<span id="cb83-29"><a href="#cb83-29"></a>collate <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb83-30"><a href="#cb83-30"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb83-31"><a href="#cb83-31"></a>  na_difftime <span class="ot">&lt;-</span> <span class="fu">as.difftime</span>(<span class="cn">NA_real_</span>, <span class="at">units =</span> <span class="st">"secs"</span>)</span>
<span id="cb83-32"><a href="#cb83-32"></a>  out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(...)</span>
<span id="cb83-33"><a href="#cb83-33"></a>  pipeline_start <span class="ot">&lt;-</span> out<span class="sc">$</span>pipeline_start[<span class="dv">1</span>]</span>
<span id="cb83-34"><a href="#cb83-34"></a>  out<span class="sc">$</span>pipeline_start <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb83-35"><a href="#cb83-35"></a>  out <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb83-36"><a href="#cb83-36"></a>    out,</span>
<span id="cb83-37"><a href="#cb83-37"></a>    tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb83-38"><a href="#cb83-38"></a>      <span class="at">name         =</span> <span class="st">"trace"</span>,</span>
<span id="cb83-39"><a href="#cb83-39"></a>      <span class="at">worker_pid   =</span> <span class="fu">Sys.getpid</span>(),</span>
<span id="cb83-40"><a href="#cb83-40"></a>      <span class="at">begins_at    =</span> <span class="fu">difftime</span>(start, pipeline_start),</span>
<span id="cb83-41"><a href="#cb83-41"></a>      <span class="at">finishes_at  =</span> <span class="fu">difftime</span>(<span class="fu">Sys.time</span>(), pipeline_start)</span>
<span id="cb83-42"><a href="#cb83-42"></a>    )</span>
<span id="cb83-43"><a href="#cb83-43"></a>  )</span>
<span id="cb83-44"><a href="#cb83-44"></a>  out<span class="sc">$</span>duration    <span class="ot">&lt;-</span> out<span class="sc">$</span>finishes_at <span class="sc">-</span> out<span class="sc">$</span>begins_at</span>
<span id="cb83-45"><a href="#cb83-45"></a>  out<span class="sc">$</span>begins_at   <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(out<span class="sc">$</span>begins_at), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb83-46"><a href="#cb83-46"></a>  out<span class="sc">$</span>finishes_at <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(out<span class="sc">$</span>finishes_at), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb83-47"><a href="#cb83-47"></a>  out<span class="sc">$</span>duration    <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(out<span class="sc">$</span>duration), <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb83-48"><a href="#cb83-48"></a>  out</span>
<span id="cb83-49"><a href="#cb83-49"></a>}</span>
<span id="cb83-50"><a href="#cb83-50"></a></span>
<span id="cb83-51"><a href="#cb83-51"></a><span class="fu">list</span>(</span>
<span id="cb83-52"><a href="#cb83-52"></a>  <span class="fu">tar_target</span>(start, <span class="fu">startup</span>(), <span class="at">cue =</span> <span class="fu">tar_cue</span>(<span class="st">"always"</span>)),</span>
<span id="cb83-53"><a href="#cb83-53"></a>  <span class="fu">tar_target</span>(wait1, <span class="fu">sleeper</span>(<span class="dv">1</span>, start<span class="sc">$</span>pipeline_start, <span class="st">"wait1"</span>)),</span>
<span id="cb83-54"><a href="#cb83-54"></a>  <span class="fu">tar_target</span>(wait2, <span class="fu">sleeper</span>(<span class="dv">2</span>, start<span class="sc">$</span>pipeline_start, <span class="st">"wait2"</span>)),</span>
<span id="cb83-55"><a href="#cb83-55"></a>  <span class="fu">tar_target</span>(wait3, <span class="fu">sleeper</span>(<span class="dv">3</span>, start<span class="sc">$</span>pipeline_start, <span class="st">"wait3"</span>)),</span>
<span id="cb83-56"><a href="#cb83-56"></a>  <span class="fu">tar_target</span>(wait4, <span class="fu">sleeper</span>(<span class="dv">4</span>, start<span class="sc">$</span>pipeline_start, <span class="st">"wait4"</span>)),</span>
<span id="cb83-57"><a href="#cb83-57"></a>  <span class="fu">tar_target</span>(trace, <span class="fu">collate</span>(start, wait1, wait2, wait3, wait4))</span>
<span id="cb83-58"><a href="#cb83-58"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>To give you a sense of the dependencies, this is what the targets network looks like for this version of the pipeline. All four <code>wait</code> targets depend on the <code>start</code> target, and the <code>trace</code> target depends on everything:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_visnetwork</span>(<span class="at">targets_only =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-48e6565275f1592f6a3f" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-48e6565275f1592f6a3f">{"x":{"nodes":{"name":["start","trace","wait1","wait2","wait3","wait4"],"type":["stem","stem","stem","stem","stem","stem"],"description":[null,null,null,null,null,null],"status":["outdated","outdated","outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null,null,null],"bytes":[null,null,null,null,null,null],"branches":[null,null,null,null,null,null],"label":["start","trace","wait1","wait2","wait3","wait4"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["start","trace","wait1","wait2","wait3","wait4"],"level":[1,3,2,2,2,2],"shape":["dot","dot","dot","dot","dot","dot"]},"edges":{"from":["start","start","start","start","start","wait1","wait2","wait3","wait4"],"to":["wait1","wait2","wait3","wait4","trace","trace","trace","trace","trace"],"arrows":["to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem"],"color":["#78B7C5","#899DA4"],"shape":["dot","dot"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>In hindsight, I realised that this could have been done more efficiently, but efficiency is not the primary goal here. I just want a pipeline in which all the targets report some detailed information about their execution. So let’s run it and see what we get:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_make</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>▶ dispatched target start
● completed target start [0.009 seconds, 274 bytes]
▶ dispatched target wait1
▶ dispatched target wait2
▶ dispatched target wait3
● completed target wait1 [1.003 seconds, 281 bytes]
▶ dispatched target wait4
● completed target wait2 [2.015 seconds, 284 bytes]
● completed target wait3 [3.005 seconds, 284 bytes]
● completed target wait4 [4.022 seconds, 284 bytes]
▶ dispatched target trace
● completed target trace [0.021 seconds, 343 bytes]
▶ ended pipeline [7.136 seconds]</code></pre>
</div>
</div>
<p>Okay yes this makes sense. Every other target is dependent on <code>start</code>, and by design this target is <em>always</em> treated as outdated. So when the pipeline begins, the first thing that happens is that the <code>start</code> target is dispatched to a worker; the other two workers do nothing. Once <code>start</code> completes, all four wait targets are eligible for dispatch, but we only have three workers and so <code>wait1</code>, <code>wait2</code>, and <code>wait4</code> are farmed out to workers while <code>wait4</code> remains in the queue. When <code>wait1</code> completes, one of the workers is freed up, thereby allowing <code>wait4</code> to be dispatched. Once all four of the wait targets are completed, the final <code>trace</code> target is built.</p>
<p>If we call <code>tar_crew()</code>, we get the same high-level overview that we got last time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>crew  <span class="ot">&lt;-</span> <span class="fu">tar_crew</span>()</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>crew</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  controller               worker seconds targets
  &lt;chr&gt;                    &lt;chr&gt;    &lt;dbl&gt;   &lt;int&gt;
1 ee4c5b3554e06b8b84c75f3a 1         4.12       4
2 ee4c5b3554e06b8b84c75f3a 2         4.11       1
3 ee4c5b3554e06b8b84c75f3a 3         2.1        1</code></pre>
</div>
</div>
<p>However, this time around we also have access to the <code>trace</code> target that provides a more detailed summary of which R process excecuted each target, and at what time that execution started and stopped:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>trace <span class="ot">&lt;-</span> <span class="fu">tar_read</span>(trace)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>trace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  name  worker_pid begins_at finishes_at duration
  &lt;chr&gt;      &lt;int&gt;     &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;
1 start    1227869     0            0       0    
2 wait1    1227869     0.038        1.04    1.00 
3 wait2    1227931     1.28         3.28    2.00 
4 wait3    1227869     1.04         4.05    3.00 
5 wait4    1227925     1.27         5.27    4.00 
6 trace    1227869     5.32         5.32    0.004</code></pre>
</div>
</div>
<p>In this data frame, the <code>begins_at</code> column records the amount of time that has passed between the time at which the pipeline started, and the time at which the current target begins execution. Similarly <code>finishes_at</code> records the time from pipeline start to the current target finishing. The <code>duration</code> column is the difference between the two. That being said, if you look at the code I used to calculate these, it’s clearly an approximation. But it will suffice.</p>
<p>The nice thing about the <code>trace</code> data is that the <code>worker_pid</code> column associates each target with a specific pid for the R process used to build that target. This is slightly finer-grained information than what we got by calling <code>tar_crew()</code>. For example, I now know that <code>start</code> and <code>wait1</code> were both executed by the same R process (i.e., pid 1227869). Admittedly this is not much of a revelation: I could have guessed that just by looking at the logs when I called <code>tar_make()</code> and a few reasonable assumptions about how the scheduler<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> works.</p>
<p>One minor irritation I have with the <code>trace</code> output is that it doesn’t directly allow me to match the <code>worker_pid</code> column against the <code>worker</code> column produced by <code>tar_crew()</code>. You can see the issue most cleanly if I aggregate the <code>trace</code> data frame by <code>worker_pid</code> like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>trace_sum <span class="ot">&lt;-</span> trace <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(worker_pid, duration) <span class="sc">|&gt;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">seconds =</span> <span class="fu">sum</span>(duration), </span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">targets =</span> <span class="fu">n</span>(), </span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> worker_pid</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>trace_sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  worker_pid seconds targets
       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;
1    1227869    4.01       4
2    1227931    2.00       1
3    1227925    4.00       1</code></pre>
</div>
</div>
<p>Looking at this it’s immediately apparent that worker 1 must corresponded to the R process with pid 1227869, since <code>trace</code> and <code>crew</code> both agree that this is the only worker that executed four distinct targets. However, workers 2 and 3 both executed a single target, so we’ll have to resolve the ambiguity by looking at the <code>seconds</code> column. This is a little awkward because <code>trace_sum$seconds</code> will necessarily be slightly lower than <code>crew$seconds</code> because the time estimate in the <code>trace</code> data is constructed from <em>within</em> the R process that builds the target, but <code>tar_crew()</code> would (I assume) estimate the time from outside that process. The differences will be small, but noticeable. So I’ll use a rolling join:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>worker_lookup <span class="ot">&lt;-</span> crew <span class="sc">|&gt;</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    trace_sum, </span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(targets, <span class="fu">closest</span>(x<span class="sc">$</span>seconds <span class="sc">&gt;</span> y<span class="sc">$</span>seconds))</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(worker, worker_pid)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>worker_lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  worker worker_pid
  &lt;chr&gt;       &lt;int&gt;
1 1         1227869
2 2         1227925
3 3         1227931</code></pre>
</div>
</div>
<p>It’s not ideal but it works: we now have a mapping between the numeric <code>worker</code> value returned by <code>tar_crew()</code> and the <code>worker_pid</code> value returned when <code>Sys.getpid()</code> is called from within the target function. Joining this gives us the following table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>target_trace <span class="ot">&lt;-</span> trace <span class="sc">|&gt;</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(worker_lookup, <span class="at">by =</span> <span class="st">"worker_pid"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(worker, <span class="at">.before =</span> <span class="st">"worker_pid"</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>target_trace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  name  worker worker_pid begins_at finishes_at duration    id
  &lt;chr&gt; &lt;chr&gt;       &lt;int&gt;     &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;int&gt;
1 start 1         1227869     0            0       0         1
2 wait1 1         1227869     0.038        1.04    1.00      2
3 wait2 3         1227931     1.28         3.28    2.00      3
4 wait3 1         1227869     1.04         4.05    3.00      4
5 wait4 2         1227925     1.27         5.27    4.00      5
6 trace 1         1227869     5.32         5.32    0.004     6</code></pre>
</div>
</div>
<p>Or, to adopt a slightly nicer way of looking at it, we can draw a picture:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(target_trace, <span class="fu">aes</span>(begins_at, worker, <span class="at">color =</span> name)) <span class="sc">+</span> </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> finishes_at, <span class="at">yend =</span> worker)) <span class="sc">+</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> finishes_at)) <span class="sc">+</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"time"</span>, <span class="at">y =</span> <span class="st">"worker"</span>, <span class="at">color =</span> <span class="st">"target"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/threading-2-trace-plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Okay yes, this now gives a detailed sense of which targets are dispatched to which workers, and at what time, but it does leave one thing missing: the total elapsed time shown by <code>target_trace</code> is about 5-6 seconds, but when I called <code>tar_make()</code> the total elapsed time was reported to be a little over 7 seconds. The discrepancy between the two is that the timing information recorded by my code doesn’t account for the time that the targets package spends setting up the pipeline, and recording metadata and target values in the <code>_targets</code> folder.</p>
</section>
<section id="epilogue-2" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="epilogue-2">Epilogue</h3>
<p>One thing that bothered me a <em>lot</em> about the second version, when I implemented it, was this nagging intuition that most of what I was doing felt unnecessary. Certainly, there’s a limitation to the output of <code>tar_crew()</code> in the sense that it doesn’t tell you the worker to which each target was assigned, nor does it report the pid for each worker. That seems a little odd to me, but I am very willing to believe there’s a good reason for that.</p>
<p>The part that seemed utterly baffling to me was seeing that the on-screen output to <code>tar_make()</code> reports the execution time for each target, but (at the time) I couldn’t work out how to extract that information programmatically. It beggars belief to think that a package as sophisticated as targets wouldn’t record that information somewhere and…</p>
<p>…yeah, of course it does. I was just looking in the wrong place. If you call <code>tar_meta()</code> it returns a tibble that stores a detailed listing of all targets – including the “secret”<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> one that records the value of <a href="../../posts/2023-12-27_seedcatcher/"><code>.Random.seed</code></a> – that includes their execution time, any warnings or errors produced during their execution, and a great deal more besides:</p>
<div class="cell column-page">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_meta</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 18
   name         type     data             command          depend                  seed path      time                size             bytes format repository iteration parent children  seconds warnings error
   &lt;chr&gt;        &lt;chr&gt;    &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;                  &lt;int&gt; &lt;list&gt;    &lt;dttm&gt;              &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;  &lt;list&gt;      &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;
 1 startup      function 050b477467191bc8 &lt;NA&gt;             &lt;NA&gt;                      NA &lt;chr [1]&gt; NA                  &lt;NA&gt;                NA &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;   &lt;chr [1]&gt;  NA     &lt;NA&gt;     &lt;NA&gt; 
 2 collate      function e1dc164dfb76a1e6 &lt;NA&gt;             &lt;NA&gt;                      NA &lt;chr [1]&gt; NA                  &lt;NA&gt;                NA &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;   &lt;chr [1]&gt;  NA     &lt;NA&gt;     &lt;NA&gt; 
 3 .Random.seed object   28950222af780342 &lt;NA&gt;             &lt;NA&gt;                      NA &lt;chr [1]&gt; NA                  &lt;NA&gt;                NA &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;   &lt;chr [1]&gt;  NA     &lt;NA&gt;     &lt;NA&gt; 
 4 sleeper      function 5ead800f7ec58068 &lt;NA&gt;             &lt;NA&gt;                      NA &lt;chr [1]&gt; NA                  &lt;NA&gt;                NA &lt;NA&gt;   &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;   &lt;chr [1]&gt;  NA     &lt;NA&gt;     &lt;NA&gt; 
 5 start        stem     0c77f67e87bc43d2 2098fa32bc94d489 b151447ecf216509 -1013159115 &lt;chr [1]&gt; 2025-01-10 11:37:51 7588b18ac8276279   274 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   0.009 &lt;NA&gt;     &lt;NA&gt; 
 6 wait1        stem     00f655abfa250dcd 8900681d4f1181ad ca20d184fd39fc55  1208061404 &lt;chr [1]&gt; 2025-01-10 11:37:52 1945721079faa963   281 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   1.00  &lt;NA&gt;     &lt;NA&gt; 
 7 wait2        stem     ec6076acf46bb83c adfb6c7b6993720a ca20d184fd39fc55 -2106940369 &lt;chr [1]&gt; 2025-01-10 11:37:54 38b61ce0f7e2cdb4   284 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   2.02  &lt;NA&gt;     &lt;NA&gt; 
 8 wait3        stem     ca7bfe83a30cc415 71bbae8135d59048 ca20d184fd39fc55   216419040 &lt;chr [1]&gt; 2025-01-10 11:37:55 38b61ce0f7e2cdb4   284 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   3.00  &lt;NA&gt;     &lt;NA&gt; 
 9 wait4        stem     2d48f39a97604a5e 709dbf0fe45e36da ca20d184fd39fc55 -1433985599 &lt;chr [1]&gt; 2025-01-10 11:37:56 38b61ce0f7e2cdb4   284 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   4.02  &lt;NA&gt;     &lt;NA&gt; 
10 trace        stem     62abcec67fd170f4 e0601f48904584d2 75a31c5a5fd79694   -31475585 &lt;chr [1]&gt; 2025-01-10 11:37:56 c206c709607ca69c   343 rds    local      vector    &lt;NA&gt;   &lt;chr [1]&gt;   0.021 &lt;NA&gt;     &lt;NA&gt; </code></pre>
</div>
</div>
<p>True, it doesn’t contain information about the system pid that executes the target, so I’d still have some work to do, but at least now I have the correct timing information for each target.</p>
<p>Oh well. I’ll know better next time, and anyway the entire point of this exercise was to teach myself how to use the package, so it’s all good really.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In all fairness, this is the <em>primary</em> purpose of this blog. Yes, it makes me very happy that other people find my posts useful and/or enjoyable, but that is actually a secondary goal. I write these posts for myself, because the act of writing is also an act of learning for me.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>You can also call <code>tar_manifest()</code> to get a slightly more precise list of the targets and the commands with which they are associated, but I’m not going to bother with that here.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>I mean, if you’ve reached the point where you’re <em>manually</em> invalidating parts of the R markdown cache to spare yourself 15 minutes of compute time every time you want to tinker with a figure, girl he’s not the man for you and it’s time to look for better options.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Okay fine, yes, if you’ve read the user manual you’d probably recognise that static branching would also work here if you were clever enough, and if I’m honest that was what I tried first. But then I realised that a blog is genuinely better suited to dynamic branching and the code was soooooo much simpler this way, so that’s what I ran with in the end.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>In all honesty I don’t think this decision to use underscores to represent folder structure is a great design feature. Yes there was some logic for it at the time, but the underscore has an accepted meaning in the various R-based literate programming tools, and it is not good practice to violate user expectations the way I’m doing here. However, this is a silly side project that is not intended to be used for anything, so I feel no compunction at all about violating conventions.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Why is the <code>url</code> field never used? Should <code>pattern</code> really be called that? Shouldn’t some of these be private methods/fields? Blah blah blah. I threw this together quickly, it’s not meant to be taken seriously.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Well, millenials. Not young people. The actual young people in my life keep talking about “rizz” and telling me what slaps, and sending memes I don’t understand. Frankly I need them to stop. My brain melted when my daughter tried to explain “skibidi” and it has never truly recovered.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>These are absolute paths on my local filesystem, but in hindsight this seems like a bad choice: it would make more sense for them to be relative paths, taken from the blog root folder. Oh well.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>This is the default behaviour for litedown, and while I believe you can change this, I’m still learning litedown and frankly I like this as a default, so I left it as is.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>I hasten to add that nobody should be using the <a href="https://queue.djnavarro.net/">queue</a> package. Like most of my side-projects it was something I wrote just to prove to myself that I could do it, but it’s little more than a toy.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Scheduling in <code>crew</code> is handled with the <a href="https://shikokuchuo.net/mirai/">mirai</a> package, which looks amazing and is now on my to-do list to learn.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Not very secret.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{navarro2025,
  author = {Navarro, Danielle},
  title = {Three Short Stories about Targets},
  date = {2025-01-08},
  url = {https://blog.djnavarro.net/posts/2025-01-08_using-targets/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-navarro2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Navarro, Danielle. 2025. <span>“Three Short Stories about
Targets.”</span> January 8, 2025. <a href="https://blog.djnavarro.net/posts/2025-01-08_using-targets/">https://blog.djnavarro.net/posts/2025-01-08_using-targets/</a>.
</div></div></section></div></main> <!-- /main -->
<!-- plausible -->
<script async="" defer="" data-domain="blog.djnavarro.net" src="https://plausible.io/js/plausible.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/blog\.djnavarro\.net");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://blog.djnavarro.net">
<p>blog.djnavarro.net</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>